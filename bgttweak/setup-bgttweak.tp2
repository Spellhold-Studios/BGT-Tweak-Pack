////////////////////////////////////////////////////////////
// BGT-WeiDU Tweak pack installation tp2 file
////////////////////////////////////////////////////////////

BACKUP ~BGTTweak/Backup~

AUTHOR ~http://forums.spellholdstudios.net/index.php?showforum=261~

VERSION ~9 (31 Dec 09)~

README ~BGTTweak/Language/%LANGUAGE%/Readme.htm~

//////////////////////////////////////////////////////////////////////////////////////////////////
//Macros for enemy items shatter component
//////////////////////////////////////////////////////////////////////////////////////////////////
DEFINE_PATCH_MACRO ~__24__readCRE~ BEGIN
  SET i = 0
  CLEAR_ARRAY scriptlist
  READ_ASCII 0x248 $scriptlist(4) ELSE ~~ // override
  READ_ASCII 0x250 $scriptlist(3) ELSE ~~ // class
  READ_ASCII 0x258 $scriptlist(2) ELSE ~~ // race
  READ_ASCII 0x260 $scriptlist(1) ELSE ~~ // general
  READ_ASCII 0x268 $scriptlist(0) ELSE ~~ // default
  FOR (i = 0; i < 5; i += 1) BEGIN
    TO_UPPER EVALUATE_BUFFER ~scriptlist_%i%~
  END
END


DEFINE_PATCH_MACRO ~__24__parseCRE~ BEGIN
  LAUNCH_PATCH_MACRO ~__24__readCRE~

  SET found = 0

  //check all CRE scripts to see if extended script already present
  PATCH_PHP_EACH scriptlist AS idx => script BEGIN
    PATCH_IF FILE_EXISTS_IN_GAME ~%script%.bcs~ BEGIN
      PATCH_IF VARIABLE_IS_SET $extendlist(EVALUATE_BUFFER "%script%") AND
               ($extendlist(EVALUATE_BUFFER "%script%") = 1) BEGIN
        SET found = 1
      END
    END
  END

  SET lowestUsage = 0x7FFFFFF
  SET lowestUsageIdx = 0xFFFFFFF
  PATCH_PHP_EACH scriptlist AS idx => script BEGIN
    PATCH_IF FILE_EXISTS_IN_GAME ~%script%.bcs~ AND
             (
               NOT VARIABLE_IS_SET $extendlist(EVALUATE_BUFFER "%script%") OR 
               (
                 VARIABLE_IS_SET $extendlist(EVALUATE_BUFFER "%script%") AND
                 $extendlist(EVALUATE_BUFFER "%script%") != 1
               )
             ) AND
             (
               NOT VARIABLE_IS_SET $excludelist(EVALUATE_BUFFER "%script%") OR 
               (
                 VARIABLE_IS_SET $excludelist(EVALUATE_BUFFER "%script%") AND
                 $excludelist(EVALUATE_BUFFER "%script%") != 1
               )
             ) BEGIN
      //if CRE script already chosen or <5 scripts, exclude all scripts
      PATCH_IF (found OR numscripts < 5) BEGIN
        SET $excludelist(EVALUATE_BUFFER "%script%") = 1
      END ELSE BEGIN
        PATCH_IF ($scriptusage(EVALUATE_BUFFER "%script%") < lowestUsage) BEGIN
          PATCH_IF (lowestUsageIdx != 0xFFFFFFF) BEGIN
            SPRINT scriptVar EVALUATE_BUFFER ~scriptlist_%lowestUsageIdx%~
            SPRINT scriptOld EVALUATE_BUFFER ~%%scriptVar%%~
            SET $excludelist(EVALUATE_BUFFER "%scriptOld%") = 1
          END
 
          SET lowestUsage = $scriptusage(EVALUATE_BUFFER "%script%")
          SET lowestUsageIdx = idx
        END ELSE BEGIN
          SET $excludelist(EVALUATE_BUFFER "%script%") = 1
        END
      END
    END
  END

  PATCH_IF (lowestUsageIdx != 0xFFFFFFF) BEGIN
    SPRINT scriptVar EVALUATE_BUFFER ~scriptlist_%lowestUsageIdx%~
    SPRINT script EVALUATE_BUFFER ~%%scriptVar%%~
    SET $extendlist(EVALUATE_BUFFER "%script%") = 1
    SET found = 1
  END

  PATCH_IF (!found) BEGIN
    PATCH_IF (numscripts = 5) BEGIN
      SET problem = 1

      PATCH_PRINT ~%SOURCE_FILE%: all slots full for extend.~
      PATCH_SILENT

      SET isPriority = 0
      PHP_EACH prioritylist AS idx => file BEGIN
        PATCH_IF ("%SOURCE_RES%" STRING_EQUAL_CASE "%file%") BEGIN
          SET isPriority = 1
        END
      END
      PATCH_IF (!isPriority) BEGIN
        SPRINT $prioritylist(EVALUATE_BUFFER "%priorityIdx%") "%SOURCE_RES%"
        SET priorityIdx += 1
      END ELSE BEGIN
        INNER_ACTION BEGIN
          FAIL ~Conflict in priority list.~
        END
      END
    END
    SET $createlist(EVALUATE_BUFFER "%SOURCE_RES%") = 1
  END
END
//////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////
//PATCH_MACRO are_update_offset
//for addition of extended headers, this macro updates offsets of all extended headers that occur later than the extended header modified, then updates offsets stored in the variables
//////////////////////////////////////////////////////////////////////////////////////////////////
//Variables that need to be defined:
// -are_update_offset_increment
// -are_update_offset_datatype (can be actor, info, spawn, entrance, container, item, vertex, ambient, variable, door, explored, anim, tiled, song, rest, automap)
//////////////////////////////////////////////////////////////////////////////////////////////////
//Other requirements:
// -all types of %are_update_offset_datatype%_off must have been read
// -the specified %are_update_offset_datatype%_num must have been read
//////////////////////////////////////////////////////////////////////////////////////////////////
DEFINE_PATCH_MACRO are_update_offset BEGIN
  SPRINT are_update_offset_datatype_off "%are_update_offset_datatype%_off"
  SPRINT are_update_offset_datatype_num "%are_update_offset_datatype%_num"

  PATCH_IF (NOT (("%are_update_offset_datatype%" STRING_COMPARE_CASE "actor")=0))
            AND (("%actor_off%" > EVALUATE_BUFFER "%%are_update_offset_datatype_off%%")
            OR (("%actor_off%" = EVALUATE_BUFFER "%%are_update_offset_datatype_off%%") AND (EVALUATE_BUFFER "%%are_update_offset_datatype_num%%" = 0))) BEGIN
    WRITE_LONG 0x54 ("%actor_off%" + "%are_update_offset_increment%")
  END
  PATCH_IF (NOT (("%are_update_offset_datatype%" STRING_COMPARE_CASE "info")=0))   
            AND (("%info_off%" > EVALUATE_BUFFER "%%are_update_offset_datatype_off%%")
            OR (("%info_off%" = EVALUATE_BUFFER "%%are_update_offset_datatype_off%%") AND (EVALUATE_BUFFER "%%are_update_offset_datatype_num%%" = 0))) BEGIN
    WRITE_LONG 0x5c ("%info_off%" + "%are_update_offset_increment%")
  END
  PATCH_IF (NOT (("%are_update_offset_datatype%" STRING_COMPARE_CASE "spawn")=0))
            AND (("%spawn_off%" > EVALUATE_BUFFER "%%are_update_offset_datatype_off%%")
            OR (("%spawn_off%" = EVALUATE_BUFFER "%%are_update_offset_datatype_off%%") AND (EVALUATE_BUFFER "%%are_update_offset_datatype_num%%" = 0))) BEGIN
    WRITE_LONG 0x60 ("%spawn_off%" + "%are_update_offset_increment%")
  END
  PATCH_IF (NOT (("%are_update_offset_datatype%" STRING_COMPARE_CASE "entrance")=0))
            AND (("%entrance_off%" > EVALUATE_BUFFER "%%are_update_offset_datatype_off%%")
            OR (("%entrance_off%" = EVALUATE_BUFFER "%%are_update_offset_datatype_off%%") AND (EVALUATE_BUFFER "%%are_update_offset_datatype_num%%" = 0))) BEGIN
    WRITE_LONG 0x68 ("%entrance_off%" + "%are_update_offset_increment%")
  END
  PATCH_IF (NOT (("%are_update_offset_datatype%" STRING_COMPARE_CASE "container")=0))
            AND (("%container_off%" > EVALUATE_BUFFER "%%are_update_offset_datatype_off%%")
            OR (("%container_off%" = EVALUATE_BUFFER "%%are_update_offset_datatype_off%%") AND (EVALUATE_BUFFER "%%are_update_offset_datatype_num%%" = 0))) BEGIN
    WRITE_LONG 0x70 ("%container_off%" + "%are_update_offset_increment%")
  END
  PATCH_IF (NOT (("%are_update_offset_datatype%" STRING_COMPARE_CASE "item")=0))
            AND (("%item_off%" > EVALUATE_BUFFER "%%are_update_offset_datatype_off%%")
            OR (("%item_off%" = EVALUATE_BUFFER "%%are_update_offset_datatype_off%%") AND (EVALUATE_BUFFER "%%are_update_offset_datatype_num%%" = 0))) BEGIN
    WRITE_LONG 0x78 ("%item_off%" + "%are_update_offset_increment%")
  END
  PATCH_IF (NOT (("%are_update_offset_datatype%" STRING_COMPARE_CASE "vertex")=0))
            AND (("%vertex_off%" > EVALUATE_BUFFER "%%are_update_offset_datatype_off%%")
            OR (("%vertex_off%" = EVALUATE_BUFFER "%%are_update_offset_datatype_off%%") AND (EVALUATE_BUFFER "%%are_update_offset_datatype_num%%" = 0))) BEGIN
    WRITE_LONG 0x7c ("%vertex_off%" + "%are_update_offset_increment%")
  END
  PATCH_IF (NOT (("%are_update_offset_datatype%" STRING_COMPARE_CASE "ambient")=0))
            AND (("%ambient_off%" > EVALUATE_BUFFER "%%are_update_offset_datatype_off%%")
            OR (("%ambient_off%" = EVALUATE_BUFFER "%%are_update_offset_datatype_off%%") AND (EVALUATE_BUFFER "%%are_update_offset_datatype_num%%" = 0))) BEGIN
    WRITE_LONG 0x84 ("%ambient_off%" + "%are_update_offset_increment%")
  END
  PATCH_IF (NOT (("%are_update_offset_datatype%" STRING_COMPARE_CASE "variable")=0))
            AND (("%variable_off%" > EVALUATE_BUFFER "%%are_update_offset_datatype_off%%")
            OR (("%variable_off%" = EVALUATE_BUFFER "%%are_update_offset_datatype_off%%") AND (EVALUATE_BUFFER "%%are_update_offset_datatype_num%%" = 0))) BEGIN
    WRITE_LONG 0x88 ("%variable_off%" + "%are_update_offset_increment%")
  END
  PATCH_IF (NOT (("%are_update_offset_datatype%" STRING_COMPARE_CASE "door")=0))
            AND (("%door_off%" > EVALUATE_BUFFER "%%are_update_offset_datatype_off%%")
            OR (("%door_off%" = EVALUATE_BUFFER "%%are_update_offset_datatype_off%%") AND (EVALUATE_BUFFER "%%are_update_offset_datatype_num%%" = 0))) BEGIN
    WRITE_LONG 0xa8 ("%door_off%" + "%are_update_offset_increment%")
  END
  PATCH_IF (NOT (("%are_update_offset_datatype%" STRING_COMPARE_CASE "explored")=0))
            AND (("%explored_off%" > EVALUATE_BUFFER "%%are_update_offset_datatype_off%%")
            OR (("%explored_off%" = EVALUATE_BUFFER "%%are_update_offset_datatype_off%%") AND (EVALUATE_BUFFER "%%are_update_offset_datatype_num%%" = 0))) BEGIN
    WRITE_LONG 0xa0 ("%explored_off%" + "%are_update_offset_increment%")
  END
  PATCH_IF (NOT (("%are_update_offset_datatype%" STRING_COMPARE_CASE "anim")=0))
            AND (("%anim_off%" > EVALUATE_BUFFER "%%are_update_offset_datatype_off%%")
            OR (("%anim_off%" = EVALUATE_BUFFER "%%are_update_offset_datatype_off%%") AND (EVALUATE_BUFFER "%%are_update_offset_datatype_num%%" = 0))) BEGIN
    WRITE_LONG 0xb0 ("%anim_off%" + "%are_update_offset_increment%")
  END
  PATCH_IF (NOT (("%are_update_offset_datatype%" STRING_COMPARE_CASE "tiled")=0))
            AND (("%tiled_off%" > EVALUATE_BUFFER "%%are_update_offset_datatype_off%%")
            OR (("%tiled_off%" = EVALUATE_BUFFER "%%are_update_offset_datatype_off%%") AND (EVALUATE_BUFFER "%%are_update_offset_datatype_num%%" = 0))) BEGIN
    WRITE_LONG 0xb8 ("%tiled_off%" + "%are_update_offset_increment%")
  END
  PATCH_IF (NOT (("%are_update_offset_datatype%" STRING_COMPARE_CASE "song")=0))
            AND (("%song_off%" > EVALUATE_BUFFER "%%are_update_offset_datatype_off%%")
            OR (("%song_off%" = EVALUATE_BUFFER "%%are_update_offset_datatype_off%%") AND (EVALUATE_BUFFER "%%are_update_offset_datatype_num%%" = 0))) BEGIN
    WRITE_LONG 0xbc ("%song_off%" + "%are_update_offset_increment%")
  END
  PATCH_IF (NOT (("%are_update_offset_datatype%" STRING_COMPARE_CASE "rest")=0))
            AND (("%rest_off%" > EVALUATE_BUFFER "%%are_update_offset_datatype_off%%")
            OR (("%rest_off%" = EVALUATE_BUFFER "%%are_update_offset_datatype_off%%") AND (EVALUATE_BUFFER "%%are_update_offset_datatype_num%%" = 0))) BEGIN
    WRITE_LONG 0xc0 ("%rest_off%" + "%are_update_offset_increment%")
  END
  PATCH_IF (NOT (("%are_update_offset_datatype%" STRING_COMPARE_CASE "automap")=0))
            AND (("%automap_off%" > EVALUATE_BUFFER "%%are_update_offset_datatype_off%%")
            OR (("%automap_off%" = EVALUATE_BUFFER "%%are_update_offset_datatype_off%%") AND (EVALUATE_BUFFER "%%are_update_offset_datatype_num%%" = 0))) BEGIN
    WRITE_LONG 0xc4 ("%automap_off%" + "%are_update_offset_increment%")
  END

  READ_LONG 0x54 actor_off
  READ_LONG 0x5c info_off
  READ_LONG 0x60 spawn_off
  READ_LONG 0x68 entrance_off
  READ_LONG 0x70 container_off
  READ_LONG 0x78 item_off
  READ_LONG 0x7c vertex_off
  READ_LONG 0x84 ambient_off
  READ_LONG 0x88 variable_off
  READ_LONG 0xa8 door_off
  READ_LONG 0xa0 explored_off
  READ_LONG 0xb0 anim_off
  READ_LONG 0xb8 tiled_off
  READ_LONG 0xbc song_off
  READ_LONG 0xc0 rest_off
  READ_LONG 0xc4 automap_off

END
//////////////////////////////////////////////////////////////////////////////////////////////////

LANGUAGE ~English~
         ~English~
         ~BGTTweak/Language/English/prompts.tra~
         ~BGTTweak/Language/English/setup.tra~
LANGUAGE ~Castellano (Castilian/Spanish)~
         ~Castilian~
         ~BGTTweak/Language/Castilian/prompts.tra~
         ~BGTTweak/Language/Castilian/setup.tra~
LANGUAGE ~Francais (French)~
         ~French~
         ~BGTTweak/Language/French/prompts.tra~
         ~BGTTweak/Language/French/setup.tra~
LANGUAGE ~Deutsch (German)~
         ~German~
         ~BGTTweak/Language/German/prompts.tra~
         ~BGTTweak/Language/German/setup.tra~
LANGUAGE ~Italiano (Italian)~
         ~Italian~
         ~BGTTweak/Language/Italian/prompts.tra~
         ~BGTTweak/Language/Italian/setup.tra~
LANGUAGE ~«—±πæÓ (Korean)~
         ~Korean~
         ~BGTTweak/Language/Korean/prompts.tra~
         ~BGTTweak/Language/Korean/setup.tra~
LANGUAGE ~Polski (Polish)~
         ~Polish~
         ~BGTTweak/Language/Polish/prompts.tra~
         ~BGTTweak/Language/Polish/setup.tra~
LANGUAGE ~ê„··™®© (Russian)~
         ~Russian~
         ~BGTTweak/Language/Russian/prompts.tra~
         ~BGTTweak/Language/Russian/setup.tra~
LANGUAGE ~ºÚÃÂ÷–Œƒ (Simplified Chinese)~
         ~SChinese~
         ~BGTTweak/Language/SChinese/prompts.tra~
         ~BGTTweak/Language/SChinese/setup.tra~
LANGUAGE %¡c≈È§§§Â (Traditional Chinese)%
         ~TChinese~
         ~BGTTweak/Language/TChinese/prompts.tra~
         ~BGTTweak/Language/TChinese/setup.tra~

//#1 Eldoth reminds of Skie's ransom/////////////////////////
BEGIN @100
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 100

EXTEND_BOTTOM ~ELDOTH.BCS~ ~BGTTweak/1/aELDOTH.BAF~
COMPILE ~BGTTweak/1/aELDOTJ.D~
/////////////////////////////////////////////////////////////



//#2 Angelo notices Shar-teel////////////////////////////////
BEGIN @200
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 200
DEPRECATED ~This component has been moved to the BG1 Unfinished Business modification.~
FORBID_FILE ~override/X#BG1NPCPhase2.G3~ @3

COMPILE ~BGTTweak/2/rANGELO.D~
EXTEND_BOTTOM ~AR7607.BCS~ ~BGTTweak/2/xAR7607.BAF~
/////////////////////////////////////////////////////////////



//#3 Finishable Kagain caravan quest/////////////////////////
BEGIN @300
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 300
DEPRECATED ~This component has been moved to the BG1 Unfinished Business modification.~
FORBID_FILE ~override/X#BG1NPCCore.G3~ @2

COPY_EXISTING ~AR6900.BCS~ ~override~
  DECOMPILE_BCS_TO_BAF
  REPLACE_TEXTUALLY ~GlobalLT~ ~Global~
  REPLACE_TEXTUALLY ~SetGlobal("KagainCaravan","GLOBAL",2)~ ~SetGlobal("KagainLostChildQuest","GLOBAL",2)~
  COMPILE_BAF_TO_BCS
EXTEND_BOTTOM ~AR6900.BCS~ ~BGTTweak/3/aAR6900.BAF~
COPY_EXISTING ~KAGAIN.BCS~ ~override~
  REPLACE_BCS_BLOCK ~BGTTweak/3/xKAGAIN.BAF~ ~BGTTweak/3/rKAGAIN.BAF~

COMPILE ~BGTTweak/3/rKAGAIJ.D~
COPY ~BGTTweak/3/DLOSTKAG.CRE~ ~override~
/////////////////////////////////////////////////////////////



//#4 Add Semaj's Cloak and Upgraded Koveras' Ring of Protection//
BEGIN @400
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 400

COPY ~BGTTweak/4/CLCK33.ITM~ ~override~
  SAY NAME1 @401
  SAY NAME2 @402
  SAY UNIDENTIFIED_DESC @403
  SAY IDENTIFIED_DESC @404

COPY ~BGTTweak/4/RING25B.ITM~ ~override~
  SAY IDENTIFIED_DESC @405

COPY_EXISTING ~SEMAJ.CRE~ ~override~
  ADD_CRE_ITEM ~CLCK33~ #0 #0 #0 ~NONE~ ~CLOAK~

COPY_EXISTING ~AR0602.BCS~ ~override~
  REPLACE_BCS_BLOCK ~BGTTweak/4/rAR0602.BAF~ ~BGTTweak/4/xAR0602.BAF~
  DECOMPILE_BCS_TO_BAF
  REPLACE_TEXTUALLY ~"RING25"~ ~"RING25B"~
  COMPILE_BAF_TO_BCS

COPY_EXISTING ~ARAM00.BCS~ ~override~
  REPLACE_BCS_BLOCK ~BGTTweak/4/rARAM00.BAF~ ~BGTTweak/4/xARAM00.BAF~
/////////////////////////////////////////////////////////////



//#5 Major locations explored upon visit/////////////////////
BEGIN @500
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 500

EXTEND_TOP ~AR0015.BCS~ ~BGTTweak/5/aEXPLORE.BAF~
EXTEND_TOP ~AR3700.BCS~ ~BGTTweak/5/aEXPLORE.BAF~
EXTEND_TOP ~AR6526.BCS~ ~BGTTweak/5/aEXPLORE.BAF~
EXTEND_TOP ~AR6700.BCS~ ~BGTTweak/5/aEXPLORE.BAF~
EXTEND_TOP ~AR7200.BCS~ ~BGTTweak/5/aEXPLORE.BAF~
EXTEND_TOP ~AR7300.BCS~ ~BGTTweak/5/aEXPLORE.BAF~
EXTEND_TOP ~AR7400.BCS~ ~BGTTweak/5/aEXPLORE.BAF~
EXTEND_TOP ~AR7600.BCS~ ~BGTTweak/5/aEXPLORE.BAF~
EXTEND_TOP ~AR7700.BCS~ ~BGTTweak/5/aEXPLORE.BAF~
EXTEND_TOP ~AR7800.BCS~ ~BGTTweak/5/aEXPLORE.BAF~
EXTEND_TOP ~AR8000.BCS~ ~BGTTweak/5/aEXPLORE.BAF~
EXTEND_TOP ~AR8100.BCS~ ~BGTTweak/5/aEXPLORE.BAF~
EXTEND_TOP ~AR8200.BCS~ ~BGTTweak/5/aEXPLORE.BAF~
EXTEND_TOP ~ARU000.BCS~ ~BGTTweak/5/aEXPLORE.BAF~
/////////////////////////////////////////////////////////////



//#6 Druid-responsive bears in BG1///////////////////////////
BEGIN @600
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 600
FORBID_FILE ~override/BG1UBCreCorrect.UB~ @6

COPY_EXISTING ~BEAR.BCS~  ~override~
  REPLACE_BCS_BLOCK ~BGTTweak/6/rBEAR.BAF~ ~BGTTweak/6/xBEAR.BAF~
/////////////////////////////////////////////////////////////



//#7 Happy patch ////////////////////////////////////////////
//NPCs cannot choose to leave the party
BEGIN @701 SUBCOMPONENT @700
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 701
FORBID_COMPONENT ~Setup-Ease.tp2~ 25 @4

COPY_EXISTING ~HAPPY.2DA~ ~override~
  COUNT_2DA_ROWS 4 happy_rows
  FOR(i=0;i<"%happy_rows%";i+=1) BEGIN
    SET happy_col = 1
    WHILE ("%happy_col%" <= 3) BEGIN
      READ_2DA_ENTRY %i% %happy_col% 4 happy_val
      PATCH_IF ("%happy_val%" < 0) BEGIN
        SET_2DA_ENTRY %i% %happy_col% 4 "0"
      END
      SET happy_col +=1
    END
  END
BUT_ONLY_IF_IT_CHANGES
//////////////////////////////////////////////////////////////
//Only good and evil NPCs leave the party
BEGIN @702 SUBCOMPONENT @700
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 702
FORBID_COMPONENT ~Setup-Ease.tp2~ 25 @4

COMPILE ~BGTTweak/7/Happy.D~
//////////////////////////////////////////////////////////////



//#8 Import more items into Shadows of Amn////////////////////
BEGIN @800
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 800

//Backwards compatibility with versions 1.05a or older
ACTION_IF FILE_EXISTS_IN_GAME ~RINGA0.ITM~ BEGIN
  OUTER_SPRINT ~RingOfWizardry~ ~RINGA0~
END
ELSE BEGIN
  OUTER_SPRINT ~RingOfWizardry~ ~BGRING08~
END

COPY_EXISTING ~AR0602.BCS~ ~override~
  REPLACE_BCS_BLOCK ~BGTTweak/8/rAR0602.BAF~ ~BGTTweak/8/xAR0602.BAF~
  EVALUATE_BUFFER

COPY_EXISTING ~ARAM00.BCS~ ~override~
  REPLACE_BCS_BLOCK ~BGTTweak/8/rARAM00.BAF~ ~BGTTweak/8/xARAM00.BAF~
  EVALUATE_BUFFER
//////////////////////////////////////////////////////////////



//#9 Random activated traps in the pirate cave////////////////
BEGIN @901 SUBCOMPONENT @900
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 901

RANDOM_SEED reset //seeds to the current time

COPY_EXISTING ~AR9501.ARE~ ~override~
  SPRINT Random1 "GTAR"
  SPRINT Random2 "GTAR2"
  SPRINT Random3 "GTAR3"
  SPRINT Random4 "GTAR4"
  SPRINT Random5 "GTAR5"
  SPRINT Random6 "GTAR6"
  SPRINT Random7 "GTAR7"
  SPRINT Random8 "GTAR8"
  SPRINT Random9 "GTAR9"
  SPRINT Random10 "GTAR10"
  SPRINT Random11 "GTAS"
  SPRINT Random12 "GTCK"
  SPRINT Random13 "GTCON"
  SPRINT Random14 "GTCORB"
  SPRINT Random15 "GTDC"
  SPRINT Random16 "GTFB"
  SPRINT Random17 "GTFB2"
  SPRINT Random18 "GTFS"
  SPRINT Random19 "GTGW"
  SPRINT Random20 "GTHP"
  SPRINT Random21 "GTLB"
  SPRINT Random22 "GTMM"
  SPRINT Random23 "GTSC"
  SPRINT Random24 "GTSI"
  SPRINT Random25 "GTST"
  SPRINT Random26 "GTWEB"
  SET RandomTotal = 26

  READ_LONG 0x5c info_off
  READ_SHORT 0x5a info_num
  FOR (i=0;i<"%info_num%";i+=1) BEGIN
    READ_ASCII ("%info_off%" + 0xc4*"%i%") info_name
    PATCH_IF (("%info_name%" STRING_COMPARE_CASE "Trap01")=0) BEGIN
      SET RandomNum = RANDOM (1 "%RandomTotal%")
      SPRINT RandomName "Random%RandomNum%"
      SPRINT TrapScript EVALUATE_BUFFER "%%RandomName%%"
      WRITE_EVALUATED_ASCII ("%info_off%" + 0xc4*"%i%" + 0x7c) "%TrapScript%"
    END ELSE
    PATCH_IF (("%info_name%" STRING_COMPARE_CASE "Trap02")=0) BEGIN
      SET RandomNum = RANDOM (1 "%RandomTotal%")
      SPRINT RandomName "Random%RandomNum%"
      SPRINT TrapScript EVALUATE_BUFFER "%%RandomName%%"
      WRITE_EVALUATED_ASCII ("%info_off%" + 0xc4*"%i%" + 0x7c) "%TrapScript%"
    END ELSE
    PATCH_IF (("%info_name%" STRING_COMPARE_CASE "Trap03")=0) BEGIN
      SET RandomNum = RANDOM (1 "%RandomTotal%")
      SPRINT RandomName "Random%RandomNum%"
      SPRINT TrapScript EVALUATE_BUFFER "%%RandomName%%"
      WRITE_EVALUATED_ASCII ("%info_off%" + 0xc4*"%i%" + 0x7c) "%TrapScript%"
    END ELSE
    PATCH_IF (("%info_name%" STRING_COMPARE_CASE "Trap04")=0) BEGIN
      SET RandomNum = RANDOM (1 "%RandomTotal%")
      SPRINT RandomName "Random%RandomNum%"
      SPRINT TrapScript EVALUATE_BUFFER "%%RandomName%%"
      WRITE_EVALUATED_ASCII ("%info_off%" + 0xc4*"%i%" + 0x7c) "%TrapScript%"
    END
  END
//////////////////////////////////////////////////////////////
BEGIN @902 SUBCOMPONENT @900
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 902

COMPILE ~BGTTweak/9/GTAR9501.BAF~

COPY_EXISTING ~AR9501.ARE~ ~override~
  READ_LONG 0x5c info_off
  READ_SHORT 0x5a info_num
  FOR (i=0;i<"%info_num%";i+=1) BEGIN
    READ_ASCII ("%info_off%" + 0xc4*"%i%") info_name
    PATCH_IF (("%info_name%" STRING_COMPARE_CASE "Trap01")=0) BEGIN
      WRITE_ASCII ("%info_off%" + 0xc4*"%i%" + 0x7c) "GTAR9501"
    END ELSE
    PATCH_IF (("%info_name%" STRING_COMPARE_CASE "Trap02")=0) BEGIN
      WRITE_ASCII ("%info_off%" + 0xc4*"%i%" + 0x7c) "GTAR9501"
    END ELSE
    PATCH_IF (("%info_name%" STRING_COMPARE_CASE "Trap03")=0) BEGIN
      WRITE_ASCII ("%info_off%" + 0xc4*"%i%" + 0x7c) "GTAR9501"
    END ELSE
    PATCH_IF (("%info_name%" STRING_COMPARE_CASE "Trap04")=0) BEGIN
      WRITE_ASCII ("%info_off%" + 0xc4*"%i%" + 0x7c) "GTAR9501"
    END
  END
//////////////////////////////////////////////////////////////



//#10 Bags of the Sword Coast/////////////////////////////////
BEGIN @1000
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 1000

COPY ~BGTTweak/10~ ~override~

COPY_EXISTING ~FRIEND.STO~ ~override~
  ADD_STORE_ITEM ~BGBAG01~ #0 #0 #0 ~IDENTIFIED~ #1 //Gem Bag

COPY_EXISTING ~HIGHHEDG.STO~ ~override~
  ADD_STORE_ITEM ~BGBAG02~ #0 #0 #0 ~IDENTIFIED~ #1 //Scroll Case

COPY_EXISTING ~MULAHE.CRE~ ~override~
  ADD_CRE_ITEM ~BGBAG03~ #0 #0 #0 ~IDENTIFIED~ ~INV16~ //Bag of Holding

COPY_EXISTING ~ERDANE.STO~ ~override~
  ADD_STORE_ITEM ~BGBAG04~ #0 #0 #0 ~IDENTIFIED~ #1 //Ammo Belt

COPY_EXISTING ~AR9902.ARE~ ~override~
  READ_LONG 0x70 container_off
  READ_SHORT 0x74 container_num
  READ_LONG 0x78 item_off
  READ_SHORT 0x76 item_num
  READ_LONG 0x7c vertices_off
  READ_LONG 0x84 ambient_off
  READ_LONG 0x88 variables_off
  READ_LONG 0xa0 bitmap_off
  READ_LONG 0xa8 doors_off
  READ_LONG 0xb0 anim_off
  READ_LONG 0xb8 tiles_off
  READ_LONG 0xbc song_off
  READ_LONG 0xc0 restspawn_off
  READ_LONG 0xc4 automap_off

  FOR (i=0;i<"%container_num%";i+=1) BEGIN
    READ_ASCII ("%container_off%" + 0xc0*"%i%") container_name
    PATCH_IF (("%container_name%" STRING_COMPARE_CASE "LChest")=0) BEGIN
      READ_LONG ("%container_off%" + 0xc0*"%i%" + 0x40) container_item_index
      READ_LONG ("%container_off%" + 0xc0*"%i%" + 0x44) container_num_items

      //add item to the top of the index
      INSERT_BYTES ("%item_off%" + 0x14*"%container_item_index%") 0x14
      WRITE_ASCII ("%item_off%" + 0x14*"%container_item_index%") "BGBAG05" //Potion case

      //update number of items for the container and the total value
      WRITE_LONG ("%container_off%" + 0xc0*"%i%" + 0x44) ("%container_num_items%" + 1)
      WRITE_SHORT 0x76 ("%item_num%" + 1)

      //update item index for all containers after the one modified
      FOR (j=("%i%"+1);j<"%container_num%";j+=1) BEGIN
        READ_SHORT ("%container_off%" + 0xc0*"%j%" + 0x40) container_item_index_next
        WRITE_SHORT ("%container_off%" + 0xc0*"%j%" + 0x40) ("%container_item_index_next%" + 1)
      END

      //update all later offsets
      WRITE_LONG 0x7c ("%vertices_off%" + 0x14)
      WRITE_LONG 0x84 ("%ambient_off%" + 0x14)
      WRITE_LONG 0x88 ("%variables_off%" + 0x14)
      WRITE_LONG 0xa0 ("%bitmap_off%" + 0x14)
      WRITE_LONG 0xa8 ("%doors_off%" + 0x14)
      WRITE_LONG 0xb0 ("%anim_off%" + 0x14)
      WRITE_LONG 0xb8 ("%tiles_off%" + 0x14)
      WRITE_LONG 0xbc ("%song_off%" + 0x14)
      WRITE_LONG 0xc0 ("%restspawn_off%" + 0x14)
      WRITE_LONG 0xc4 ("%automap_off%" + 0x14)
    END
  END
//////////////////////////////////////////////////////////////



//#11 Levelled spawns/////////////////////////////////////////
BEGIN @1101 SUBCOMPONENT @1100
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
FORBID_COMPONENT ~Setup-BGSpawn.tp2~ ~0~ @12
DESIGNATED 1101

COPY ~BGTTweak/11/info~ ~BGTTweak/11/info~
  SPRINT source "%SOURCE_RES%"
  SET info_vertex_num_new_total = 0

  //ignore the placeholder and any 0-byte files
  PATCH_IF NOT ("%SOURCE_SIZE%" = 0) BEGIN
    FOR (i=0;i<10000;i+=1) BEGIN
      READ_ASCII ("%i%"*0xc4) info_data_new (196)
      READ_ASCII (("%i%" + 1)*0xc4) buffer ELSE 10000 (196) //check if next read is at illegal offset
      READ_SHORT ("%i%"*0xc4 + 0x2a) info_vertex_num_new
      SET info_vertex_num_new_total += "%info_vertex_num_new%"

      //add to the corresponding ARE file with the same ResRef
      INNER_ACTION BEGIN
        COPY_EXISTING ~%source%.ARE~ ~override/%source%.ARE~
          READ_LONG 0x54 actor_off
          READ_LONG 0x5c info_off
          READ_LONG 0x60 spawn_off
          READ_LONG 0x68 entrance_off
          READ_LONG 0x70 container_off
          READ_LONG 0x78 item_off
          READ_LONG 0x7c vertex_off
          READ_LONG 0x84 ambient_off
          READ_LONG 0x88 variable_off
          READ_LONG 0xa8 door_off
          READ_LONG 0xa0 explored_off
          READ_LONG 0xb0 anim_off
          READ_LONG 0xb8 tiled_off
          READ_LONG 0xbc song_off
          READ_LONG 0xc0 rest_off
          READ_LONG 0xc4 automap_off

          READ_SHORT 0x5a info_num
          READ_SHORT 0x64 spawn_num
          READ_SHORT 0x74 container_num
          READ_SHORT 0x80 vertex_num
          READ_SHORT 0xa4 door_num

          //deactivate spawn point using its flag
          FOR (n=0;n<"%spawn_num%";n+=1) BEGIN
            WRITE_SHORT ("%spawn_off%" + "%n%"*0xc8 + 0x86) 0
          END

          //update offsets for info information insert first
          SPRINT are_update_offset_datatype "info"
          SET are_update_offset_increment = 196
          LAUNCH_PATCH_MACRO are_update_offset

          //insert info information at the top of the info list
          INSERT_BYTES "%info_off%" 196
          WRITE_EVALUATED_ASCII "%info_off%" "%info_data_new%" #196
          WRITE_LONG ("%info_off%" + 0x2c) 0 //set first vertex index to zero
          SET info_num +=1
          WRITE_SHORT 0x5a "%info_num%"

          //update offsets for vertex information insert
          SPRINT are_update_offset_datatype "vertex"
          SET are_update_offset_increment = 0x4 * "%info_vertex_num_new%"
          LAUNCH_PATCH_MACRO are_update_offset

          //insert vertex information at the top of the vertex list
          FOR (j=0;j<"%info_vertex_num_new%";j+=1) BEGIN
            
            INNER_ACTION BEGIN
              COPY ~BGTTweak/11/vertex/%source%.vtx~ ~BGTTweak/11/vertex/%source%.vtx~
                READ_LONG (("%j%" + "%info_vertex_num_new_total%" - "%info_vertex_num_new%")*0x4) vertex_data_new
              BUT_ONLY_IF_IT_CHANGES
            END          

            READ_SHORT 0x80 vertex_num
            INSERT_BYTES ("%vertex_off%") 4
            WRITE_LONG ("%vertex_off%") "%vertex_data_new%"
            SET vertex_num +=1
            WRITE_SHORT 0x80 "%vertex_num%"
          END

          //update vertex indices for info points after the new Info Point 0
          FOR (k=1;k<"%info_num%";k+=1) BEGIN
            READ_SHORT ("%info_off%" + "%k%"*0xc4 + 0x2c) info_vertex_first_idx
            WRITE_SHORT ("%info_off%" + "%k%"*0xc4 + 0x2c) ("%info_vertex_first_idx%" + "%info_vertex_num_new%")
          END

          //update vertex indices for doors
          FOR (l=0;l<"%door_num%";l+=1) BEGIN
            READ_LONG ("%door_off%" + "%l%"*0xc8 + 0x2c) door_vertex_open_first_idx
            READ_LONG ("%door_off%" + "%l%"*0xc8 + 0x34) door_vertex_closed_first_idx
            READ_LONG ("%door_off%" + "%l%"*0xc8 + 0x48) door_vertex_impede_closed_first_idx
            READ_LONG ("%door_off%" + "%l%"*0xc8 + 0x50) door_vertex_impede_open_first_idx
            WRITE_LONG ("%door_off%" + "%l%"*0xc8 + 0x2c) ("%door_vertex_open_first_idx%" + "%info_vertex_num_new%")
            WRITE_LONG ("%door_off%" + "%l%"*0xc8 + 0x34) ("%door_vertex_closed_first_idx%" + "%info_vertex_num_new%")
            WRITE_LONG ("%door_off%" + "%l%"*0xc8 + 0x48) ("%door_vertex_impede_closed_first_idx%" + "%info_vertex_num_new%")
            WRITE_LONG ("%door_off%" + "%l%"*0xc8 + 0x50) ("%door_vertex_impede_open_first_idx%" + "%info_vertex_num_new%")
          END

          //update vertex indices for containers
          FOR (m=0;m<"%container_num%";m+=1) BEGIN
            READ_LONG ("%container_off%" + "%m%"*0xc0 + 0x50) container_vertex_first_idx
            WRITE_LONG ("%container_off%" + "%m%"*0xc0 + 0x50) ("%container_vertex_first_idx%" + "%info_vertex_num_new%")
          END

        BUT_ONLY_IF_IT_CHANGES
      END

      //stop the FOR loop on an illegal offset read
      PATCH_IF (("%buffer%" STRING_COMPARE_CASE "10000")=0) BEGIN
        SET i = 10000
      END
    END
  END
BUT_ONLY_IF_IT_CHANGES

COMPILE ~BGTTweak/11/scripts~
//////////////////////////////////////////////////////////////
BEGIN @1102 SUBCOMPONENT @1100
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
FORBID_COMPONENT ~Setup-BGSpawn.tp2~ ~0~ @12
DESIGNATED 1102

COPY_EXISTING ~AR3100.ARE~ ~override~
              ~AR3200.ARE~ ~override~
              ~AR3300.ARE~ ~override~
              ~AR3400.ARE~ ~override~
              ~AR3401.ARE~ ~override~
              ~AR3498.ARE~ ~override~
              ~AR3499.ARE~ ~override~
              ~AR3800.ARE~ ~override~
              ~AR3900.ARE~ ~override~
              ~AR4100.ARE~ ~override~
              ~AR4200.ARE~ ~override~
              ~AR4300.ARE~ ~override~
              ~AR4400.ARE~ ~override~
              ~AR4600.ARE~ ~override~
              ~AR6519.ARE~ ~override~
              ~AR6600.ARE~ ~override~
              ~AR6900.ARE~ ~override~
              ~AR7000.ARE~ ~override~
              ~AR7100.ARE~ ~override~
              ~AR7223.ARE~ ~override~
              ~AR7324.ARE~ ~override~
              ~AR7325.ARE~ ~override~
              ~AR7326.ARE~ ~override~
              ~AR8300.ARE~ ~override~
              ~AR8400.ARE~ ~override~
              ~AR8500.ARE~ ~override~
              ~AR8600.ARE~ ~override~
              ~AR8602.ARE~ ~override~
              ~AR8700.ARE~ ~override~
              ~AR8800.ARE~ ~override~
              ~AR8900.ARE~ ~override~
              ~AR9000.ARE~ ~override~
              ~AR9100.ARE~ ~override~
              ~AR9200.ARE~ ~override~
              ~AR9300.ARE~ ~override~
              ~AR9400.ARE~ ~override~
              ~AR9500.ARE~ ~override~
              ~AR9600.ARE~ ~override~
              ~AR9700.ARE~ ~override~
              ~AR9798.ARE~ ~override~
              ~AR9799.ARE~ ~override~
              ~AR9900.ARE~ ~override~
              ~ARA100.ARE~ ~override~
              ~ARD000.ARE~ ~override~
              ~ARD011.ARE~ ~override~
              ~ARD014.ARE~ ~override~
              ~ARW000.ARE~ ~override~
              ~ARW012.ARE~ ~override~
              ~ARW500.ARE~ ~override~
  READ_LONG 0x60 spawn_off
  READ_SHORT 0x64 spawn_num

  FOR (n=0;n<"%spawn_num%";n+=1) BEGIN
    WRITE_SHORT ("%spawn_off%" + "%n%"*0xc8 + 0x86) 0 //isActive = FALSE
    WRITE_SHORT ("%spawn_off%" + "%n%"*0xc8 + 0x8c) 100 //probDay
    WRITE_SHORT ("%spawn_off%" + "%n%"*0xc8 + 0x8e) 100 //probNight
  END
BUT_ONLY_IF_IT_CHANGES

EXTEND_BOTTOM ~AR7100.BCS~ ~BGTTweak/11/NoSpawn/xAR7100.BAF~
//////////////////////////////////////////////////////////////
/*BEGIN @1103 SUBCOMPONENT @1100
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
FORBID_COMPONENT ~Setup-BGSpawn.tp2~ ~0~ @12
DESIGNATED 1103

//deactivate BGT spawn points
COPY_EXISTING ~AR3100.ARE~ ~override~
              ~AR3200.ARE~ ~override~
              ~AR3300.ARE~ ~override~
              ~AR3400.ARE~ ~override~
              ~AR3401.ARE~ ~override~
              ~AR3498.ARE~ ~override~
              ~AR3499.ARE~ ~override~
              ~AR3800.ARE~ ~override~
              ~AR3900.ARE~ ~override~
              ~AR4100.ARE~ ~override~
              ~AR4200.ARE~ ~override~
              ~AR4300.ARE~ ~override~
              ~AR4400.ARE~ ~override~
              ~AR4600.ARE~ ~override~
              ~AR6519.ARE~ ~override~
              ~AR6600.ARE~ ~override~
              ~AR6900.ARE~ ~override~
              ~AR7000.ARE~ ~override~
              ~AR7100.ARE~ ~override~
              ~AR7223.ARE~ ~override~
              ~AR7324.ARE~ ~override~
              ~AR7325.ARE~ ~override~
              ~AR7326.ARE~ ~override~
              ~AR8300.ARE~ ~override~
              ~AR8400.ARE~ ~override~
              ~AR8500.ARE~ ~override~
              ~AR8600.ARE~ ~override~
              ~AR8602.ARE~ ~override~
              ~AR8700.ARE~ ~override~
              ~AR8800.ARE~ ~override~
              ~AR8900.ARE~ ~override~
              ~AR9000.ARE~ ~override~
              ~AR9100.ARE~ ~override~
              ~AR9200.ARE~ ~override~
              ~AR9300.ARE~ ~override~
              ~AR9400.ARE~ ~override~
              ~AR9500.ARE~ ~override~
              ~AR9600.ARE~ ~override~
              ~AR9700.ARE~ ~override~
              ~AR9798.ARE~ ~override~
              ~AR9799.ARE~ ~override~
              ~AR9900.ARE~ ~override~
              ~ARA100.ARE~ ~override~
              ~ARD000.ARE~ ~override~
              ~ARD011.ARE~ ~override~
              ~ARD014.ARE~ ~override~
              ~ARW000.ARE~ ~override~
              ~ARW012.ARE~ ~override~
              ~ARW500.ARE~ ~override~
  READ_LONG 0x60 spawn_off
  READ_SHORT 0x64 spawn_num

  FOR (n=0;n<"%spawn_num%";n+=1) BEGIN
    //deactivate spawn point using its flag
    WRITE_SHORT ("%spawn_off%" + "%n%"*0xc8 + 0x86) 0
  END
BUT_ONLY_IF_IT_CHANGES

//delete all actors from random encounter areas
COPY_EXISTING ~AR4700.ARE~ ~override/AR4700.ARE~
              ~AR4701.ARE~ ~override/AR4701.ARE~
              ~AR4800.ARE~ ~override/AR4800.ARE~
              ~AR4801.ARE~ ~override/AR4801.ARE~
              ~AR4900.ARE~ ~override/AR4900.ARE~
              ~AR4901.ARE~ ~override/AR4901.ARE~
              ~AR5100.ARE~ ~override/AR5100.ARE~
              ~AR5101.ARE~ ~override/AR5101.ARE~
              ~AR5300.ARE~ ~override/AR5300.ARE~
              ~AR5301.ARE~ ~override/AR5301.ARE~
              ~AR5400.ARE~ ~override/AR5400.ARE~
  READ_LONG 0x54 actor_off
  READ_LONG 0x5c info_off
  READ_LONG 0x60 spawn_off
  READ_LONG 0x68 entrance_off
  READ_LONG 0x70 container_off
  READ_LONG 0x78 item_off
  READ_LONG 0x7c vertex_off
  READ_LONG 0x84 ambient_off
  READ_LONG 0x88 variable_off
  READ_LONG 0xa8 door_off
  READ_LONG 0xa0 explored_off
  READ_LONG 0xb0 anim_off
  READ_LONG 0xb8 tiled_off
  READ_LONG 0xbc song_off
  READ_LONG 0xc0 rest_off
  READ_LONG 0xc4 automap_off

  READ_SHORT 0x58 actor_num
  WRITE_SHORT 0x58 0

  //delete all actors
  DELETE_BYTES ("%actor_off%") (0x110 * "%actor_num%")

  //update offsets
  SPRINT are_update_offset_datatype "actor"
  SET are_update_offset_increment = 0 - 272
  PATCH_PRINT "%are_update_offset_increment%"
  FOR (i = 0; i < "%actor_num%"; i += 1) BEGIN
   LAUNCH_PATCH_MACRO are_update_offset
  END
BUT_ONLY_IF_IT_CHANGES

//if script file does not already exist, compile an empty version
COPY ~BGTTweak/11/EasyTutu/BAFextend~ ~BGTTweak/11/EasyTutu/BAFextend~
  INNER_ACTION BEGIN
    ACTION_IF NOT FILE_EXISTS_IN_GAME ~%SOURCE_RES%.BCS~ THEN BEGIN
      <<<<<<<< %SOURCE_RES%.BAF
>>>>>>>>
      COMPILE ~%SOURCE_RES%.BAF~
    END
  END
BUT_ONLY_IF_IT_CHANGES

//add spawning script to areas
EXTEND_BOTTOM ~AR3100.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR3100.baf~
EXTEND_BOTTOM ~AR3200.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR3200.baf~
EXTEND_BOTTOM ~AR3300.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR3300.baf~
EXTEND_BOTTOM ~AR3400.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR3400.baf~
EXTEND_BOTTOM ~AR3401.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR3401.baf~
EXTEND_BOTTOM ~AR3498.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR3498.baf~
EXTEND_BOTTOM ~AR3499.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR3499.baf~
EXTEND_BOTTOM ~AR3900.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR3900.baf~
EXTEND_BOTTOM ~AR4100.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR4100.baf~
EXTEND_BOTTOM ~AR4200.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR4200.baf~
EXTEND_BOTTOM ~AR4300.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR4300.baf~
EXTEND_BOTTOM ~AR4400.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR4400.baf~
EXTEND_BOTTOM ~AR4600.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR4600.baf~
EXTEND_BOTTOM ~AR4700.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR4700.baf~
EXTEND_BOTTOM ~AR4701.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR4701.baf~
EXTEND_BOTTOM ~AR4800.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR4800.baf~
EXTEND_BOTTOM ~AR4801.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR4801.baf~
EXTEND_BOTTOM ~AR4900.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR4900.baf~
EXTEND_BOTTOM ~AR4901.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR4901.baf~
EXTEND_BOTTOM ~AR5100.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR5100.baf~
EXTEND_BOTTOM ~AR5101.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR5101.baf~
EXTEND_BOTTOM ~AR5300.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR5300.baf~
EXTEND_BOTTOM ~AR5301.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR5301.baf~
EXTEND_BOTTOM ~AR5400.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR5400.baf~
EXTEND_BOTTOM ~AR6519.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR6519.baf~
EXTEND_BOTTOM ~AR6600.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR6600.baf~
EXTEND_BOTTOM ~AR6900.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR6900.baf~
EXTEND_BOTTOM ~AR7000.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR7000.baf~
EXTEND_BOTTOM ~AR7100.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR7100.baf~
EXTEND_BOTTOM ~AR7223.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR7223.baf~
EXTEND_BOTTOM ~AR7324.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR7324.baf~
EXTEND_BOTTOM ~AR7325.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR7325.baf~
EXTEND_BOTTOM ~AR7326.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR7326.baf~
EXTEND_BOTTOM ~AR8300.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR8300.baf~
EXTEND_BOTTOM ~AR8400.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR8400.baf~
EXTEND_BOTTOM ~AR8500.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR8500.baf~
EXTEND_BOTTOM ~AR8600.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR8600.baf~
EXTEND_BOTTOM ~AR8602.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR8602.baf~
EXTEND_BOTTOM ~AR8700.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR8700.baf~
EXTEND_BOTTOM ~AR8800.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR8800.baf~
EXTEND_BOTTOM ~AR8900.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR8900.baf~
EXTEND_BOTTOM ~AR9000.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR9000.baf~
EXTEND_BOTTOM ~AR9100.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR9100.baf~
EXTEND_BOTTOM ~AR9200.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR9200.baf~
EXTEND_BOTTOM ~AR9300.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR9300.baf~
EXTEND_BOTTOM ~AR9400.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR9400.baf~
EXTEND_BOTTOM ~AR9500.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR9500.baf~
EXTEND_BOTTOM ~AR9600.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR9600.baf~
EXTEND_BOTTOM ~AR9700.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR9700.baf~
EXTEND_BOTTOM ~AR9798.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR9798.baf~
EXTEND_BOTTOM ~AR9799.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR9799.baf~
EXTEND_BOTTOM ~AR9900.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/AR9900.baf~
EXTEND_BOTTOM ~ARA100.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/ARA100.baf~
EXTEND_BOTTOM ~ARD000.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/ARD000.baf~
EXTEND_BOTTOM ~ARD011.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/ARD011.baf~
EXTEND_BOTTOM ~ARD014.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/ARD014.baf~
EXTEND_BOTTOM ~ARW000.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/ARW000.baf~
EXTEND_BOTTOM ~ARW012.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/ARW012.baf~
EXTEND_BOTTOM ~ARW500.BCS~ ~BGTTweak/11/EasyTutu/BAFextend/ARW500.baf~

//install creatures that control spawning
COPY ~BGTTweak/11/EasyTutu/CRE~ ~override~

//install scripts for creatures
COMPILE ~BGTTweak/11/EasyTutu/BAF~*/
//////////////////////////////////////////////////////////////
BEGIN @1104 SUBCOMPONENT @1100
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
FORBID_COMPONENT ~Setup-BGSpawn.tp2~ ~0~ @12
DESIGNATED 1104

COPY_EXISTING ~AR3100.ARE~ ~override~
              ~AR3200.ARE~ ~override~
              ~AR3300.ARE~ ~override~
              ~AR3400.ARE~ ~override~
              ~AR3401.ARE~ ~override~
              ~AR3498.ARE~ ~override~
              ~AR3499.ARE~ ~override~
              ~AR3800.ARE~ ~override~
              ~AR3900.ARE~ ~override~
              ~AR4100.ARE~ ~override~
              ~AR4200.ARE~ ~override~
              ~AR4300.ARE~ ~override~
              ~AR4400.ARE~ ~override~
              ~AR4600.ARE~ ~override~
              ~AR6519.ARE~ ~override~
              ~AR6600.ARE~ ~override~
              ~AR6900.ARE~ ~override~
              ~AR7000.ARE~ ~override~
              ~AR7100.ARE~ ~override~
              ~AR7223.ARE~ ~override~
              ~AR7324.ARE~ ~override~
              ~AR7325.ARE~ ~override~
              ~AR7326.ARE~ ~override~
              ~AR8300.ARE~ ~override~
              ~AR8400.ARE~ ~override~
              ~AR8500.ARE~ ~override~
              ~AR8600.ARE~ ~override~
              ~AR8602.ARE~ ~override~
              ~AR8700.ARE~ ~override~
              ~AR8800.ARE~ ~override~
              ~AR8900.ARE~ ~override~
              ~AR9000.ARE~ ~override~
              ~AR9100.ARE~ ~override~
              ~AR9200.ARE~ ~override~
              ~AR9300.ARE~ ~override~
              ~AR9400.ARE~ ~override~
              ~AR9500.ARE~ ~override~
              ~AR9600.ARE~ ~override~
              ~AR9700.ARE~ ~override~
              ~AR9798.ARE~ ~override~
              ~AR9799.ARE~ ~override~
              ~AR9900.ARE~ ~override~
              ~ARA100.ARE~ ~override~
              ~ARD000.ARE~ ~override~
              ~ARD011.ARE~ ~override~
              ~ARD014.ARE~ ~override~
              ~ARW000.ARE~ ~override~
              ~ARW012.ARE~ ~override~
              ~ARW500.ARE~ ~override~
  READ_LONG 0x60 spawn_off
  READ_SHORT 0x64 spawn_num

  FOR (n=0;n<"%spawn_num%";n+=1) BEGIN
    WRITE_SHORT ("%spawn_off%" + "%n%"*0xc8 + 0x86) 0 //isActive = FALSE
    WRITE_SHORT ("%spawn_off%" + "%n%"*0xc8 + 0x8c) 100 //probDay
    WRITE_SHORT ("%spawn_off%" + "%n%"*0xc8 + 0x8e) 100 //probNight
  END
BUT_ONLY_IF_IT_CHANGES

ACTION_IF !(FILE_EXISTS_IN_GAME ~AR3100.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR3100.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR3100.BCS~ ~BGTTweak/11/SpawnOnce/AR3100.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR3200.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR3200.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR3200.BCS~ ~BGTTweak/11/SpawnOnce/AR3200.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR3300.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR3300.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR3300.BCS~ ~BGTTweak/11/SpawnOnce/AR3300.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR3400.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR3400.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR3400.BCS~ ~BGTTweak/11/SpawnOnce/AR3400.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR3401.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR3401.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR3401.BCS~ ~BGTTweak/11/SpawnOnce/AR3401.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR3498.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR3498.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR3498.BCS~ ~BGTTweak/11/SpawnOnce/AR3498.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR3499.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR3499.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR3499.BCS~ ~BGTTweak/11/SpawnOnce/AR3499.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR3800.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR3800.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR3800.BCS~ ~BGTTweak/11/SpawnOnce/AR3800.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR3900.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR3900.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR3900.BCS~ ~BGTTweak/11/SpawnOnce/AR3900.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR4100.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR4100.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR4100.BCS~ ~BGTTweak/11/SpawnOnce/AR4100.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR4200.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR4200.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR4200.BCS~ ~BGTTweak/11/SpawnOnce/AR4200.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR4300.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR4300.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR4300.BCS~ ~BGTTweak/11/SpawnOnce/AR4300.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR4400.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR4400.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR4400.BCS~ ~BGTTweak/11/SpawnOnce/AR4400.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR4600.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR4600.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR4600.BCS~ ~BGTTweak/11/SpawnOnce/AR4600.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR6519.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR6519.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR6519.BCS~ ~BGTTweak/11/SpawnOnce/AR6519.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR6600.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR6600.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR6600.BCS~ ~BGTTweak/11/SpawnOnce/AR6600.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR6900.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR6900.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR6900.BCS~ ~BGTTweak/11/SpawnOnce/AR6900.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR7000.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR7000.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR7000.BCS~ ~BGTTweak/11/SpawnOnce/AR7000.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR7100.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR7100.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR7100.BCS~ ~BGTTweak/11/SpawnOnce/AR7100.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR7223.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR7223.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR7223.BCS~ ~BGTTweak/11/SpawnOnce/AR7223.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR7324.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR7324.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR7324.BCS~ ~BGTTweak/11/SpawnOnce/AR7324.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR7325.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR7325.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR7325.BCS~ ~BGTTweak/11/SpawnOnce/AR7325.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR7326.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR7326.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR7326.BCS~ ~BGTTweak/11/SpawnOnce/AR7326.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR8300.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR8300.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR8300.BCS~ ~BGTTweak/11/SpawnOnce/AR8300.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR8400.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR8400.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR8400.BCS~ ~BGTTweak/11/SpawnOnce/AR8400.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR8500.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR8500.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR8500.BCS~ ~BGTTweak/11/SpawnOnce/AR8500.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR8600.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR8600.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR8600.BCS~ ~BGTTweak/11/SpawnOnce/AR8600.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR8602.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR8602.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR8602.BCS~ ~BGTTweak/11/SpawnOnce/AR8602.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR8700.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR8700.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR8700.BCS~ ~BGTTweak/11/SpawnOnce/AR8700.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR8800.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR8800.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR8800.BCS~ ~BGTTweak/11/SpawnOnce/AR8800.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR8900.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR8900.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR8900.BCS~ ~BGTTweak/11/SpawnOnce/AR8900.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR9000.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR9000.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR9000.BCS~ ~BGTTweak/11/SpawnOnce/AR9000.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR9100.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR9100.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR9100.BCS~ ~BGTTweak/11/SpawnOnce/AR9100.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR9200.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR9200.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR9200.BCS~ ~BGTTweak/11/SpawnOnce/AR9200.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR9300.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR9300.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR9300.BCS~ ~BGTTweak/11/SpawnOnce/AR9300.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR9400.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR9400.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR9400.BCS~ ~BGTTweak/11/SpawnOnce/AR9400.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR9500.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR9500.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR9500.BCS~ ~BGTTweak/11/SpawnOnce/AR9500.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR9600.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR9600.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR9600.BCS~ ~BGTTweak/11/SpawnOnce/AR9600.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR9700.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR9700.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR9700.BCS~ ~BGTTweak/11/SpawnOnce/AR9700.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR9798.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR9798.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR9798.BCS~ ~BGTTweak/11/SpawnOnce/AR9798.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR9799.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR9799.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR9799.BCS~ ~BGTTweak/11/SpawnOnce/AR9799.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~AR9900.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/AR9900.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~AR9900.BCS~ ~BGTTweak/11/SpawnOnce/AR9900.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~ARA100.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/ARA100.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~ARA100.BCS~ ~BGTTweak/11/SpawnOnce/ARA100.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~ARD000.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/ARD000.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~ARD000.BCS~ ~BGTTweak/11/SpawnOnce/ARD000.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~ARD011.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/ARD011.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~ARD011.BCS~ ~BGTTweak/11/SpawnOnce/ARD011.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~ARD014.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/ARD014.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~ARD014.BCS~ ~BGTTweak/11/SpawnOnce/ARD014.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~ARW000.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/ARW000.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~ARW000.BCS~ ~BGTTweak/11/SpawnOnce/ARW000.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~ARW012.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/ARW012.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~ARW012.BCS~ ~BGTTweak/11/SpawnOnce/ARW012.BAF~ END
ACTION_IF !(FILE_EXISTS_IN_GAME ~ARW500.BCS~) THEN BEGIN COMPILE ~BGTTweak/11/SpawnOnce/ARW500.BAF~ END ELSE BEGIN EXTEND_BOTTOM ~ARW500.BCS~ ~BGTTweak/11/SpawnOnce/ARW500.BAF~ END
//////////////////////////////////////////////////////////////



//#12 Arkion reacts to player's reputation////////////////////
BEGIN @1200
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 1200

COMPILE ~BGTTweak/12/rARKION.D~
//////////////////////////////////////////////////////////////



//#13 Coran responds to the death of a wyvern/////////////////
BEGIN @1300
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 1300
FORBID_FILE ~override/X#BG1NPCPhase1.G3~ @5

ACTION_IF FILE_EXISTS_IN_GAME ~X#CORWYV.CRE~ THEN BEGIN
  COPY ~BGTTweak/13/aCORAN.BAF~ ~BGTTweak/13/aCORAN.BAF~
    REPLACE_TEXTUALLY ~("Wyvern")~ ~("X#CoranWyvern")~
END

EXTEND_BOTTOM ~CORAN.BCS~ ~BGTTweak/13/aCORAN.BAF~
//////////////////////////////////////////////////////////////



//#14 More bandit scalps//////////////////////////////////////
BEGIN @1400
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 1400

COPY_EXISTING ~BRITIK.CRE~ ~override~
              ~CREDUS.CRE~ ~override~
              ~HAKT.CRE~   ~override~
              ~RAIKEN.CRE~ ~override~
              ~TAUGOS.CRE~ ~override~
              ~TERSUS.CRE~ ~override~
              ~TEVEN.CRE~  ~override~
              ~VAX.CRE~    ~override~
              ~VENKT.CRE~  ~override~
  ADD_CRE_ITEM ~MISC86~ #0 #0 #0 ~NONE~ ~GLOVES~

COPY_EXISTING ~ZAL.CRE~ ~override~
  ADD_CRE_ITEM ~MISC86~ #0 #0 #0 ~NONE~ ~CLOAK~
//////////////////////////////////////////////////////////////



//#15 Altered item shattering//////////////////////////////////
BEGIN @1501 SUBCOMPONENT @1500
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 1501

COPY_EXISTING ~DPLAYER2.BCS~ ~override~
              ~DPLAYER3.BCS~ ~override~
  DECOMPILE_BCS_TO_BAF
  REPLACE_TEXTUALLY ~DisplayStringHead(Myself,[0-9]*)~ ~DisplayStringHead(Myself,1)~
  COMPILE_BAF_TO_BCS

  //backwards compatibility with BGT v1.06 and older
  PATCH_IF FILE_EXISTS_IN_GAME ~BGPOTN14.ITM~ BEGIN
    REPLACE_BCS_BLOCK ~BGTTweak/15/rDPLAY107.BAF~ ~BGTTweak/15/xDPLAY151.BAF~
  END ELSE BEGIN
    REPLACE_BCS_BLOCK ~BGTTweak/15/rDPLAY106.BAF~ ~BGTTweak/15/xDPLAY151.BAF~
  END
//////////////////////////////////////////////////////////////
BEGIN @1502 SUBCOMPONENT @1500
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 1502

EXTEND_BOTTOM ~DPLAYER2.BCS~ ~BGTTweak/15/xDPLAY152.BAF~
EXTEND_BOTTOM ~DPLAYER3.BCS~ ~BGTTweak/15/xDPLAY152.BAF~
//////////////////////////////////////////////////////////////



//#16 Hooded unarmoured mages and thieves/////////////////////
BEGIN @1600
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 1600

//Thieves -- a Tutu desquamate
COPY_EXISTING ~CHMT2A1.BAM~ ~override/CHMB1A1.BAM~
COPY_EXISTING ~CHMT2A2.BAM~ ~override/CHMB1A2.BAM~
COPY_EXISTING ~CHMT2A3.BAM~ ~override/CHMB1A3.BAM~
COPY_EXISTING ~CHMT2A4.BAM~ ~override/CHMB1A4.BAM~
COPY_EXISTING ~CHMT2A5.BAM~ ~override/CHMB1A5.BAM~
COPY_EXISTING ~CHMT2A6.BAM~ ~override/CHMB1A6.BAM~
COPY_EXISTING ~CHMT2A7.BAM~ ~override/CHMB1A7.BAM~
COPY_EXISTING ~CHMT2A8.BAM~ ~override/CHMB1A8.BAM~
COPY_EXISTING ~CHMT2A9.BAM~ ~override/CHMB1A9.BAM~
COPY_EXISTING ~CHMT2CA.BAM~ ~override/CHMB1CA.BAM~
COPY_EXISTING ~CHMT2G1.BAM~ ~override/CHMB1G1.BAM~
COPY_EXISTING ~CHMT2G11.BAM~ ~override/CHMB1G11.BAM~
COPY_EXISTING ~CHMT2G12.BAM~ ~override/CHMB1G12.BAM~
COPY_EXISTING ~CHMT2G13.BAM~ ~override/CHMB1G13.BAM~
COPY_EXISTING ~CHMT2G14.BAM~ ~override/CHMB1G14.BAM~
COPY_EXISTING ~CHMT2G15.BAM~ ~override/CHMB1G15.BAM~
COPY_EXISTING ~CHMT2G16.BAM~ ~override/CHMB1G16.BAM~
COPY_EXISTING ~CHMT2G17.BAM~ ~override/CHMB1G17.BAM~
COPY_EXISTING ~CHMT2G18.BAM~ ~override/CHMB1G18.BAM~
COPY_EXISTING ~CHMT2G19.BAM~ ~override/CHMB1G19.BAM~
COPY_EXISTING ~CHMT2SA.BAM~ ~override/CHMB1SA.BAM~
COPY_EXISTING ~CHMT2Ss.BAM~ ~override/CHMB1Ss.BAM~
COPY_EXISTING ~CHMT2Sx.BAM~ ~override/CHMB1Sx.BAM~

COPY_EXISTING ~CHFT2A1.BAM~ ~override/CHFB1A1.BAM~
COPY_EXISTING ~CHFT2A2.BAM~ ~override/CHFB1A2.BAM~
COPY_EXISTING ~CHFT2A3.BAM~ ~override/CHFB1A3.BAM~
COPY_EXISTING ~CHFT2A4.BAM~ ~override/CHFB1A4.BAM~
COPY_EXISTING ~CHFT2A5.BAM~ ~override/CHFB1A5.BAM~
COPY_EXISTING ~CHFT2A6.BAM~ ~override/CHFB1A6.BAM~
COPY_EXISTING ~CHFT2A7.BAM~ ~override/CHFB1A7.BAM~
COPY_EXISTING ~CHFT2A8.BAM~ ~override/CHFB1A8.BAM~
COPY_EXISTING ~CHFT2A9.BAM~ ~override/CHFB1A9.BAM~
COPY_EXISTING ~CHFT2CA.BAM~ ~override/CHFB1CA.BAM~
COPY_EXISTING ~CHFT2G1.BAM~ ~override/CHFB1G1.BAM~
COPY_EXISTING ~CHFT2G11.BAM~ ~override/CHFB1G11.BAM~
COPY_EXISTING ~CHFT2G12.BAM~ ~override/CHFB1G12.BAM~
COPY_EXISTING ~CHFT2G13.BAM~ ~override/CHFB1G13.BAM~
COPY_EXISTING ~CHFT2G14.BAM~ ~override/CHFB1G14.BAM~
COPY_EXISTING ~CHFT2G15.BAM~ ~override/CHFB1G15.BAM~
COPY_EXISTING ~CHFT2G16.BAM~ ~override/CHFB1G16.BAM~
COPY_EXISTING ~CHFT2G17.BAM~ ~override/CHFB1G17.BAM~
COPY_EXISTING ~CHFT2G18.BAM~ ~override/CHFB1G18.BAM~
COPY_EXISTING ~CHFT2G19.BAM~ ~override/CHFB1G19.BAM~
COPY_EXISTING ~CHFT2SA.BAM~ ~override/CHFB1SA.BAM~
COPY_EXISTING ~CHFT2Ss.BAM~ ~override/CHFB1Ss.BAM~
COPY_EXISTING ~CHFT2Sx.BAM~ ~override/CHFB1Sx.BAM~

COPY_EXISTING ~CEMT2A1.BAM~ ~override/CEMB1A1.BAM~
COPY_EXISTING ~CEMT2A2.BAM~ ~override/CEMB1A2.BAM~
COPY_EXISTING ~CEMT2A3.BAM~ ~override/CEMB1A3.BAM~
COPY_EXISTING ~CEMT2A4.BAM~ ~override/CEMB1A4.BAM~
COPY_EXISTING ~CEMT2A5.BAM~ ~override/CEMB1A5.BAM~
COPY_EXISTING ~CEMT2A6.BAM~ ~override/CEMB1A6.BAM~
COPY_EXISTING ~CEMT2A7.BAM~ ~override/CEMB1A7.BAM~
COPY_EXISTING ~CEMT2A8.BAM~ ~override/CEMB1A8.BAM~
COPY_EXISTING ~CEMT2A9.BAM~ ~override/CEMB1A9.BAM~
COPY_EXISTING ~CEMT2CA.BAM~ ~override/CEMB1CA.BAM~
COPY_EXISTING ~CEMT2G1.BAM~ ~override/CEMB1G1.BAM~
COPY_EXISTING ~CEMT2G11.BAM~ ~override/CEMB1G11.BAM~
COPY_EXISTING ~CEMT2G12.BAM~ ~override/CEMB1G12.BAM~
COPY_EXISTING ~CEMT2G13.BAM~ ~override/CEMB1G13.BAM~
COPY_EXISTING ~CEMT2G14.BAM~ ~override/CEMB1G14.BAM~
COPY_EXISTING ~CEMT2G15.BAM~ ~override/CEMB1G15.BAM~
COPY_EXISTING ~CEMT2G16.BAM~ ~override/CEMB1G16.BAM~
COPY_EXISTING ~CEMT2G17.BAM~ ~override/CEMB1G17.BAM~
COPY_EXISTING ~CEMT2G18.BAM~ ~override/CEMB1G18.BAM~
COPY_EXISTING ~CEMT2G19.BAM~ ~override/CEMB1G19.BAM~
COPY_EXISTING ~CEMT2SA.BAM~ ~override/CEMB1SA.BAM~
COPY_EXISTING ~CEMT2Ss.BAM~ ~override/CEMB1Ss.BAM~
COPY_EXISTING ~CEMT2Sx.BAM~ ~override/CEMB1Sx.BAM~

COPY_EXISTING ~CEFT2A1.BAM~ ~override/CEFB1A1.BAM~
COPY_EXISTING ~CEFT2A2.BAM~ ~override/CEFB1A2.BAM~
COPY_EXISTING ~CEFT2A3.BAM~ ~override/CEFB1A3.BAM~
COPY_EXISTING ~CEFT2A4.BAM~ ~override/CEFB1A4.BAM~
COPY_EXISTING ~CEFT2A5.BAM~ ~override/CEFB1A5.BAM~
COPY_EXISTING ~CEFT2A6.BAM~ ~override/CEFB1A6.BAM~
COPY_EXISTING ~CEFT2A7.BAM~ ~override/CEFB1A7.BAM~
COPY_EXISTING ~CEFT2A8.BAM~ ~override/CEFB1A8.BAM~
COPY_EXISTING ~CEFT2A9.BAM~ ~override/CEFB1A9.BAM~
COPY_EXISTING ~CEFT2CA.BAM~ ~override/CEFB1CA.BAM~
COPY_EXISTING ~CEFT2G1.BAM~ ~override/CEFB1G1.BAM~
COPY_EXISTING ~CEFT2G11.BAM~ ~override/CEFB1G11.BAM~
COPY_EXISTING ~CEFT2G12.BAM~ ~override/CEFB1G12.BAM~
COPY_EXISTING ~CEFT2G13.BAM~ ~override/CEFB1G13.BAM~
COPY_EXISTING ~CEFT2G14.BAM~ ~override/CEFB1G14.BAM~
COPY_EXISTING ~CEFT2G15.BAM~ ~override/CEFB1G15.BAM~
COPY_EXISTING ~CEFT2G16.BAM~ ~override/CEFB1G16.BAM~
COPY_EXISTING ~CEFT2G17.BAM~ ~override/CEFB1G17.BAM~
COPY_EXISTING ~CEFT2G18.BAM~ ~override/CEFB1G18.BAM~
COPY_EXISTING ~CEFT2G19.BAM~ ~override/CEFB1G19.BAM~
COPY_EXISTING ~CEFT2SA.BAM~ ~override/CEFB1SA.BAM~
COPY_EXISTING ~CEFT2Ss.BAM~ ~override/CEFB1Ss.BAM~
COPY_EXISTING ~CEFT2Sx.BAM~ ~override/CEFB1Sx.BAM~

COPY_EXISTING ~CDMT2A1.BAM~ ~override/CDMB1A1.BAM~
COPY_EXISTING ~CDMT2A2.BAM~ ~override/CDMB1A2.BAM~
COPY_EXISTING ~CDMT2A3.BAM~ ~override/CDMB1A3.BAM~
COPY_EXISTING ~CDMT2A4.BAM~ ~override/CDMB1A4.BAM~
COPY_EXISTING ~CDMT2A5.BAM~ ~override/CDMB1A5.BAM~
COPY_EXISTING ~CDMT2A6.BAM~ ~override/CDMB1A6.BAM~
COPY_EXISTING ~CDMT2A7.BAM~ ~override/CDMB1A7.BAM~
COPY_EXISTING ~CDMT2A8.BAM~ ~override/CDMB1A8.BAM~
COPY_EXISTING ~CDMT2A9.BAM~ ~override/CDMB1A9.BAM~
COPY_EXISTING ~CDMT2CA.BAM~ ~override/CDMB1CA.BAM~
COPY_EXISTING ~CDMT2G1.BAM~ ~override/CDMB1G1.BAM~
COPY_EXISTING ~CDMT2G11.BAM~ ~override/CDMB1G11.BAM~
COPY_EXISTING ~CDMT2G12.BAM~ ~override/CDMB1G12.BAM~
COPY_EXISTING ~CDMT2G13.BAM~ ~override/CDMB1G13.BAM~
COPY_EXISTING ~CDMT2G14.BAM~ ~override/CDMB1G14.BAM~
COPY_EXISTING ~CDMT2G15.BAM~ ~override/CDMB1G15.BAM~
COPY_EXISTING ~CDMT2G16.BAM~ ~override/CDMB1G16.BAM~
COPY_EXISTING ~CDMT2G17.BAM~ ~override/CDMB1G17.BAM~
COPY_EXISTING ~CDMT2G18.BAM~ ~override/CDMB1G18.BAM~
COPY_EXISTING ~CDMT2G19.BAM~ ~override/CDMB1G19.BAM~
COPY_EXISTING ~CDMT2SA.BAM~ ~override/CDMB1SA.BAM~
COPY_EXISTING ~CDMT2Ss.BAM~ ~override/CDMB1Ss.BAM~
COPY_EXISTING ~CDMT2Sx.BAM~ ~override/CDMB1Sx.BAM~

COPY_EXISTING ~CIMT2A1.BAM~ ~override/CIMB1A1.BAM~
COPY_EXISTING ~CIMT2A2.BAM~ ~override/CIMB1A2.BAM~
COPY_EXISTING ~CIMT2A3.BAM~ ~override/CIMB1A3.BAM~
COPY_EXISTING ~CIMT2A4.BAM~ ~override/CIMB1A4.BAM~
COPY_EXISTING ~CIMT2A5.BAM~ ~override/CIMB1A5.BAM~
COPY_EXISTING ~CIMT2A6.BAM~ ~override/CIMB1A6.BAM~
COPY_EXISTING ~CIMT2A7.BAM~ ~override/CIMB1A7.BAM~
COPY_EXISTING ~CIMT2A8.BAM~ ~override/CIMB1A8.BAM~
COPY_EXISTING ~CIMT2A9.BAM~ ~override/CIMB1A9.BAM~
COPY_EXISTING ~CIMT2CA.BAM~ ~override/CIMB1CA.BAM~
COPY_EXISTING ~CIMT2G1.BAM~ ~override/CIMB1G1.BAM~
COPY_EXISTING ~CIMT2G11.BAM~ ~override/CIMB1G11.BAM~
COPY_EXISTING ~CIMT2G12.BAM~ ~override/CIMB1G12.BAM~
COPY_EXISTING ~CIMT2G13.BAM~ ~override/CIMB1G13.BAM~
COPY_EXISTING ~CIMT2G14.BAM~ ~override/CIMB1G14.BAM~
COPY_EXISTING ~CIMT2G15.BAM~ ~override/CIMB1G15.BAM~
COPY_EXISTING ~CIMT2G16.BAM~ ~override/CIMB1G16.BAM~
COPY_EXISTING ~CIMT2G17.BAM~ ~override/CIMB1G17.BAM~
COPY_EXISTING ~CIMT2G18.BAM~ ~override/CIMB1G18.BAM~
COPY_EXISTING ~CIMT2G19.BAM~ ~override/CIMB1G19.BAM~
COPY_EXISTING ~CIMT2SA.BAM~ ~override/CIMB1SA.BAM~
COPY_EXISTING ~CIMT2Ss.BAM~ ~override/CIMB1Ss.BAM~
COPY_EXISTING ~CIMT2Sx.BAM~ ~override/CIMB1Sx.BAM~

COPY_EXISTING ~CIFT2A1.BAM~ ~override/CIFB1A1.BAM~
COPY_EXISTING ~CIFT2A2.BAM~ ~override/CIFB1A2.BAM~
COPY_EXISTING ~CIFT2A3.BAM~ ~override/CIFB1A3.BAM~
COPY_EXISTING ~CIFT2A4.BAM~ ~override/CIFB1A4.BAM~
COPY_EXISTING ~CIFT2A5.BAM~ ~override/CIFB1A5.BAM~
COPY_EXISTING ~CIFT2A6.BAM~ ~override/CIFB1A6.BAM~
COPY_EXISTING ~CIFT2A7.BAM~ ~override/CIFB1A7.BAM~
COPY_EXISTING ~CIFT2A8.BAM~ ~override/CIFB1A8.BAM~
COPY_EXISTING ~CIFT2A9.BAM~ ~override/CIFB1A9.BAM~
COPY_EXISTING ~CIFT2CA.BAM~ ~override/CIFB1CA.BAM~
COPY_EXISTING ~CIFT2G1.BAM~ ~override/CIFB1G1.BAM~
COPY_EXISTING ~CIFT2G11.BAM~ ~override/CIFB1G11.BAM~
COPY_EXISTING ~CIFT2G12.BAM~ ~override/CIFB1G12.BAM~
COPY_EXISTING ~CIFT2G13.BAM~ ~override/CIFB1G13.BAM~
COPY_EXISTING ~CIFT2G14.BAM~ ~override/CIFB1G14.BAM~
COPY_EXISTING ~CIFT2G15.BAM~ ~override/CIFB1G15.BAM~
COPY_EXISTING ~CIFT2G16.BAM~ ~override/CIFB1G16.BAM~
COPY_EXISTING ~CIFT2G17.BAM~ ~override/CIFB1G17.BAM~
COPY_EXISTING ~CIFT2G18.BAM~ ~override/CIFB1G18.BAM~
COPY_EXISTING ~CIFT2G19.BAM~ ~override/CIFB1G19.BAM~
COPY_EXISTING ~CIFT2SA.BAM~ ~override/CIFB1SA.BAM~
COPY_EXISTING ~CIFT2Ss.BAM~ ~override/CIFB1Ss.BAM~
COPY_EXISTING ~CIFT2Sx.BAM~ ~override/CIFB1Sx.BAM~

//Mages
COPY_EXISTING ~CHMW4A1.BAM~ ~override/CHMW1A1.BAM~
COPY_EXISTING ~CHMW4A2.BAM~ ~override/CHMW1A2.BAM~
COPY_EXISTING ~CHMW4A3.BAM~ ~override/CHMW1A3.BAM~
COPY_EXISTING ~CHMW4A4.BAM~ ~override/CHMW1A4.BAM~
COPY_EXISTING ~CHMW4A5.BAM~ ~override/CHMW1A5.BAM~
COPY_EXISTING ~CHMW4A6.BAM~ ~override/CHMW1A6.BAM~
COPY_EXISTING ~CHMW4A7.BAM~ ~override/CHMW1A7.BAM~
COPY_EXISTING ~CHMW4A8.BAM~ ~override/CHMW1A8.BAM~
COPY_EXISTING ~CHMW4A9.BAM~ ~override/CHMW1A9.BAM~
COPY_EXISTING ~CHMW4CA.BAM~ ~override/CHMW1CA.BAM~
COPY_EXISTING ~CHMW4G1.BAM~ ~override/CHMW1G1.BAM~
COPY_EXISTING ~CHMW4G11.BAM~ ~override/CHMW1G11.BAM~
COPY_EXISTING ~CHMW4G12.BAM~ ~override/CHMW1G12.BAM~
COPY_EXISTING ~CHMW4G13.BAM~ ~override/CHMW1G13.BAM~
COPY_EXISTING ~CHMW4G14.BAM~ ~override/CHMW1G14.BAM~
COPY_EXISTING ~CHMW4G15.BAM~ ~override/CHMW1G15.BAM~
COPY_EXISTING ~CHMW4G16.BAM~ ~override/CHMW1G16.BAM~
COPY_EXISTING ~CHMW4G17.BAM~ ~override/CHMW1G17.BAM~
COPY_EXISTING ~CHMW4G18.BAM~ ~override/CHMW1G18.BAM~
COPY_EXISTING ~CHMW4G19.BAM~ ~override/CHMW1G19.BAM~
COPY_EXISTING ~CHMW4INV.BAM~ ~override/CHMW1INV.BAM~
COPY_EXISTING ~CHMW4SA.BAM~ ~override/CHMW1SA.BAM~
COPY_EXISTING ~CHMW4Ss.BAM~ ~override/CHMW1Ss.BAM~
COPY_EXISTING ~CHMW4Sx.BAM~ ~override/CHMW1Sx.BAM~

COPY_EXISTING ~CHFW4A1.BAM~ ~override/CHFW1A1.BAM~
COPY_EXISTING ~CHFW4A2.BAM~ ~override/CHFW1A2.BAM~
COPY_EXISTING ~CHFW4A3.BAM~ ~override/CHFW1A3.BAM~
COPY_EXISTING ~CHFW4A4.BAM~ ~override/CHFW1A4.BAM~
COPY_EXISTING ~CHFW4A5.BAM~ ~override/CHFW1A5.BAM~
COPY_EXISTING ~CHFW4A6.BAM~ ~override/CHFW1A6.BAM~
COPY_EXISTING ~CHFW4A7.BAM~ ~override/CHFW1A7.BAM~
COPY_EXISTING ~CHFW4A8.BAM~ ~override/CHFW1A8.BAM~
COPY_EXISTING ~CHFW4A9.BAM~ ~override/CHFW1A9.BAM~
COPY_EXISTING ~CHFW4CA.BAM~ ~override/CHFW1CA.BAM~
COPY_EXISTING ~CHFW4G1.BAM~ ~override/CHFW1G1.BAM~
COPY_EXISTING ~CHFW4G11.BAM~ ~override/CHFW1G11.BAM~
COPY_EXISTING ~CHFW4G12.BAM~ ~override/CHFW1G12.BAM~
COPY_EXISTING ~CHFW4G13.BAM~ ~override/CHFW1G13.BAM~
COPY_EXISTING ~CHFW4G14.BAM~ ~override/CHFW1G14.BAM~
COPY_EXISTING ~CHFW4G15.BAM~ ~override/CHFW1G15.BAM~
COPY_EXISTING ~CHFW4G16.BAM~ ~override/CHFW1G16.BAM~
COPY_EXISTING ~CHFW4G17.BAM~ ~override/CHFW1G17.BAM~
COPY_EXISTING ~CHFW4G18.BAM~ ~override/CHFW1G18.BAM~
COPY_EXISTING ~CHFW4G19.BAM~ ~override/CHFW1G19.BAM~
COPY_EXISTING ~CHFW4INV.BAM~ ~override/CHFW1INV.BAM~
COPY_EXISTING ~CHFW4SA.BAM~ ~override/CHFW1SA.BAM~
COPY_EXISTING ~CHFW4Ss.BAM~ ~override/CHFW1Ss.BAM~
COPY_EXISTING ~CHFW4Sx.BAM~ ~override/CHFW1Sx.BAM~

COPY_EXISTING ~CEMW4A1.BAM~ ~override/CEMW1A1.BAM~
COPY_EXISTING ~CEMW4A2.BAM~ ~override/CEMW1A2.BAM~
COPY_EXISTING ~CEMW4A3.BAM~ ~override/CEMW1A3.BAM~
COPY_EXISTING ~CEMW4A4.BAM~ ~override/CEMW1A4.BAM~
COPY_EXISTING ~CEMW4A5.BAM~ ~override/CEMW1A5.BAM~
COPY_EXISTING ~CEMW4A6.BAM~ ~override/CEMW1A6.BAM~
COPY_EXISTING ~CEMW4A7.BAM~ ~override/CEMW1A7.BAM~
COPY_EXISTING ~CEMW4A8.BAM~ ~override/CEMW1A8.BAM~
COPY_EXISTING ~CEMW4A9.BAM~ ~override/CEMW1A9.BAM~
COPY_EXISTING ~CEMW4CA.BAM~ ~override/CEMW1CA.BAM~
COPY_EXISTING ~CEMW4G1.BAM~ ~override/CEMW1G1.BAM~
COPY_EXISTING ~CEMW4G11.BAM~ ~override/CEMW1G11.BAM~
COPY_EXISTING ~CEMW4G12.BAM~ ~override/CEMW1G12.BAM~
COPY_EXISTING ~CEMW4G13.BAM~ ~override/CEMW1G13.BAM~
COPY_EXISTING ~CEMW4G14.BAM~ ~override/CEMW1G14.BAM~
COPY_EXISTING ~CEMW4G15.BAM~ ~override/CEMW1G15.BAM~
COPY_EXISTING ~CEMW4G16.BAM~ ~override/CEMW1G16.BAM~
COPY_EXISTING ~CEMW4G17.BAM~ ~override/CEMW1G17.BAM~
COPY_EXISTING ~CEMW4G18.BAM~ ~override/CEMW1G18.BAM~
COPY_EXISTING ~CEMW4G19.BAM~ ~override/CEMW1G19.BAM~
COPY_EXISTING ~CEMW4INV.BAM~ ~override/CEMW1INV.BAM~
COPY_EXISTING ~CEMW4SA.BAM~ ~override/CEMW1SA.BAM~
COPY_EXISTING ~CEMW4Ss.BAM~ ~override/CEMW1Ss.BAM~
COPY_EXISTING ~CEMW4Sx.BAM~ ~override/CEMW1Sx.BAM~

COPY_EXISTING ~CEFW4A1.BAM~ ~override/CEFW1A1.BAM~
COPY_EXISTING ~CEFW4A2.BAM~ ~override/CEFW1A2.BAM~
COPY_EXISTING ~CEFW4A3.BAM~ ~override/CEFW1A3.BAM~
COPY_EXISTING ~CEFW4A4.BAM~ ~override/CEFW1A4.BAM~
COPY_EXISTING ~CEFW4A5.BAM~ ~override/CEFW1A5.BAM~
COPY_EXISTING ~CEFW4A6.BAM~ ~override/CEFW1A6.BAM~
COPY_EXISTING ~CEFW4A7.BAM~ ~override/CEFW1A7.BAM~
COPY_EXISTING ~CEFW4A8.BAM~ ~override/CEFW1A8.BAM~
COPY_EXISTING ~CEFW4A9.BAM~ ~override/CEFW1A9.BAM~
COPY_EXISTING ~CEFW4CA.BAM~ ~override/CEFW1CA.BAM~
COPY_EXISTING ~CEFW4G1.BAM~ ~override/CEFW1G1.BAM~
COPY_EXISTING ~CEFW4G11.BAM~ ~override/CEFW1G11.BAM~
COPY_EXISTING ~CEFW4G12.BAM~ ~override/CEFW1G12.BAM~
COPY_EXISTING ~CEFW4G13.BAM~ ~override/CEFW1G13.BAM~
COPY_EXISTING ~CEFW4G14.BAM~ ~override/CEFW1G14.BAM~
COPY_EXISTING ~CEFW4G15.BAM~ ~override/CEFW1G15.BAM~
COPY_EXISTING ~CEFW4G16.BAM~ ~override/CEFW1G16.BAM~
COPY_EXISTING ~CEFW4G17.BAM~ ~override/CEFW1G17.BAM~
COPY_EXISTING ~CEFW4G18.BAM~ ~override/CEFW1G18.BAM~
COPY_EXISTING ~CEFW4G19.BAM~ ~override/CEFW1G19.BAM~
COPY_EXISTING ~CEFW4INV.BAM~ ~override/CEFW1INV.BAM~
COPY_EXISTING ~CEFW4SA.BAM~ ~override/CEFW1SA.BAM~
COPY_EXISTING ~CEFW4Ss.BAM~ ~override/CEFW1Ss.BAM~
COPY_EXISTING ~CEFW4Sx.BAM~ ~override/CEFW1Sx.BAM~

COPY_EXISTING ~CDMW4A1.BAM~ ~override/CDMW1A1.BAM~
COPY_EXISTING ~CDMW4A2.BAM~ ~override/CDMW1A2.BAM~
COPY_EXISTING ~CDMW4A3.BAM~ ~override/CDMW1A3.BAM~
COPY_EXISTING ~CDMW4A4.BAM~ ~override/CDMW1A4.BAM~
COPY_EXISTING ~CDMW4A5.BAM~ ~override/CDMW1A5.BAM~
COPY_EXISTING ~CDMW4A6.BAM~ ~override/CDMW1A6.BAM~
COPY_EXISTING ~CDMW4A7.BAM~ ~override/CDMW1A7.BAM~
COPY_EXISTING ~CDMW4A8.BAM~ ~override/CDMW1A8.BAM~
COPY_EXISTING ~CDMW4A9.BAM~ ~override/CDMW1A9.BAM~
COPY_EXISTING ~CDMW4CA.BAM~ ~override/CDMW1CA.BAM~
COPY_EXISTING ~CDMW4G1.BAM~ ~override/CDMW1G1.BAM~
COPY_EXISTING ~CDMW4G11.BAM~ ~override/CDMW1G11.BAM~
COPY_EXISTING ~CDMW4G12.BAM~ ~override/CDMW1G12.BAM~
COPY_EXISTING ~CDMW4G13.BAM~ ~override/CDMW1G13.BAM~
COPY_EXISTING ~CDMW4G14.BAM~ ~override/CDMW1G14.BAM~
COPY_EXISTING ~CDMW4G15.BAM~ ~override/CDMW1G15.BAM~
COPY_EXISTING ~CDMW4G16.BAM~ ~override/CDMW1G16.BAM~
COPY_EXISTING ~CDMW4G17.BAM~ ~override/CDMW1G17.BAM~
COPY_EXISTING ~CDMW4G18.BAM~ ~override/CDMW1G18.BAM~
COPY_EXISTING ~CDMW4G19.BAM~ ~override/CDMW1G19.BAM~
COPY_EXISTING ~CDMW4INV.BAM~ ~override/CDMW1INV.BAM~
COPY_EXISTING ~CDMW4SA.BAM~ ~override/CDMW1SA.BAM~
COPY_EXISTING ~CDMW4Ss.BAM~ ~override/CDMW1Ss.BAM~
COPY_EXISTING ~CDMW4Sx.BAM~ ~override/CDMW1Sx.BAM~
//////////////////////////////////////////////////////////////



//#17 Salk's Pen-and-Paper ruleset corrections////////////////
BEGIN @1700
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 1700

COPY_EXISTING ~SKILLRAC.2DA~ ~override~
  SET_2DA_ENTRY 2 4 8 ~15~ // Elf Move Silently correction
  SET_2DA_ENTRY 4 4 8 ~10~ // Half-Elf Move Silently correction
  SET_2DA_ENTRY 5 4 8 ~20~ // Halfling Move Silently correction
  SET_2DA_ENTRY 6 3 8 ~10~ // Half-Orc Find Traps correction
BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~SKILLRNG.2DA~ ~override~
  SET_2DA_ENTRY 1 1 2 ~21~
BUT_ONLY_IF_IT_CHANGES
//////////////////////////////////////////////////////////////



//#18 Import more NPCs into Shadows of Amn/////////////////////
//#18-0 Alora
BEGIN @1800
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 1800

COPY_EXISTING ~ARAM00.BCS~ ~override~
 DECOMPILE_BCS_TO_BAF

 REPLACE_TEXTUALLY
~ActionOverride("Alora",LeaveParty())
    ActionOverride("Alora",ChangeAIScript("",DEFAULT))
    ActionOverride("Alora",ClearAllActions())
    ActionOverride("Alora",DestroySelf())~
~ActionOverride("Alora",LeaveParty())
    ActionOverride("Alora",ChangeAIScript("",DEFAULT))
    SetGlobal("AloraPartyBG1","GLOBAL",1)
    // Trademeet on left-side of Mazzy's house
    ActionOverride("Alora",MoveBetweenAreas("AR2000",[2478.1262],4))~

 COMPILE_BAF_TO_BCS

EXTEND_BOTTOM ~AR2000.BCS~ ~BGTTweak/18/aAR2000.BAF~
COMPILE ~BGTTweak\18\RemAlora.D~
//////////////////////////////////////////////////////////////
//#18-1 Branwen
BEGIN @1801
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 1801

COPY_EXISTING ~ARAM00.BCS~ ~override~
 DECOMPILE_BCS_TO_BAF

 REPLACE_TEXTUALLY
~ActionOverride("Branwen",LeaveParty())
    ActionOverride("Branwen",ChangeAIScript("",DEFAULT))
    ActionOverride("Branwen",ClearAllActions())
    ActionOverride("Branwen",DestroySelf())~
~ActionOverride("Branwen",LeaveParty())
    ActionOverride("Branwen",ChangeAIScript("",DEFAULT))
    SetGlobal("BranwenPartyBG1","GLOBAL",1)
    // Temple District left-side of doorway
    ActionOverride("Branwen",MoveBetweenAreas("AR0900",[1929.967],4))~

 COMPILE_BAF_TO_BCS

EXTEND_BOTTOM ~AR0900.BCS~ ~BGTTweak/18/aAR0900.BAF~
COMPILE ~BGTTweak\18\RemBranw.D~
//////////////////////////////////////////////////////////////
//#18-2 Eldoth
BEGIN @1802
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 1802

COPY_EXISTING ~ARAM00.BCS~ ~override~
 DECOMPILE_BCS_TO_BAF

 REPLACE_TEXTUALLY
~ActionOverride("Eldoth",LeaveParty())
    ActionOverride("Eldoth",ChangeAIScript("",DEFAULT))
    ActionOverride("Eldoth",ClearAllActions())
    ActionOverride("Eldoth",DestroySelf())~
~ActionOverride("Eldoth",ChangeAIScript("",OVERRIDE))~

 COMPILE_BAF_TO_BCS

COMPILE ~BGTTweak\18\RemEldot.D~
//////////////////////////////////////////////////////////////
//#18-3 Kagain
BEGIN @1803
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 1803

COPY_EXISTING ~ARAM00.BCS~ ~override~
 DECOMPILE_BCS_TO_BAF

 REPLACE_TEXTUALLY
~ActionOverride("Kagain",LeaveParty())
    ActionOverride("Kagain",ChangeAIScript("",DEFAULT))
    ActionOverride("Kagain",ClearAllActions())
    ActionOverride("Kagain",DestroySelf())~
~ActionOverride("Kagain",LeaveParty())
    ActionOverride("Kagain",ChangeAIScript("",DEFAULT))
    SetGlobal("KagainPartyBG1","GLOBAL",1)
    ActionOverride("Kagain",ChangeAIScript("SBTKAG",CLASS))
    ActionOverride("Kagain",MoveBetweenAreas("AR0020",[547.494],12))~

 COMPILE_BAF_TO_BCS

EXTEND_BOTTOM ~AR0020.BCS~ ~BGTTweak/18/aAR0020.BAF~
COMPILE ~BGTTweak\18\RemKagai.D~
//////////////////////////////////////////////////////////////
//#18-4 Kivan
BEGIN @1804
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 1804

COPY_EXISTING ~ARAM00.BCS~ ~override~
 DECOMPILE_BCS_TO_BAF

 REPLACE_TEXTUALLY
~ActionOverride("Kivan",LeaveParty())
    ActionOverride("Kivan",ChangeAIScript("",DEFAULT))
    ActionOverride("Kivan",ClearAllActions())
    ActionOverride("Kivan",DestroySelf())~
~ActionOverride("Kivan",LeaveParty())
    ActionOverride("Kivan",ChangeAIScript("",DEFAULT))
    SetGlobal("KivanPartyBG1","GLOBAL",1)
    ActionOverride("Kivan",ChangeAIScript("SBTKIV",CLASS))
    ActionOverride("Kivan",MoveBetweenAreas("AR1100",[4172.1239],4))~

 COMPILE_BAF_TO_BCS

EXTEND_BOTTOM ~AR1100.BCS~ ~BGTTweak/18/aAR1100.BAF~
COMPILE ~BGTTweak\18\RemKivan.D~
//////////////////////////////////////////////////////////////
//#18-5 Sharteel
BEGIN @1805
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 1805

COPY_EXISTING ~ARAM00.BCS~ ~override~
 DECOMPILE_BCS_TO_BAF

 REPLACE_TEXTUALLY
~ActionOverride("Sharteel",LeaveParty())
    ActionOverride("Sharteel",ChangeAIScript("",DEFAULT))
    ActionOverride("Sharteel",ClearAllActions())
    ActionOverride("Sharteel",DestroySelf())~
~ActionOverride("Sharteel",LeaveParty()
    ActionOverride("Sharteel",ChangeAIScript("",DEFAULT))
    SetGlobal("SharteelPartyBG1","GLOBAL",1)
    ActionOverride("Sharteel",ChangeAIScript("SBTSHR",CLASS))
    ActionOverride("Sharteel",MoveBetweenAreas("AR1005",[1131.335],8))~

 COMPILE_BAF_TO_BCS

EXTEND_BOTTOM ~AR1005.BCS~ ~BGTTweak/18/aAR1005.BAF~
COMPILE ~BGTTweak\18\RemShart.D~

//Set script to AR1005.ARE
COPY_EXISTING ~AR1005.ARE~ ~override/AR1005.ARE~
 WRITE_ASCII 0x94 ~AR1005~
BUT_ONLY_IF_IT_CHANGES
//////////////////////////////////////////////////////////////
//#18-6 Skie
BEGIN @1806
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 1806

COPY_EXISTING ~ARAM00.BCS~ ~override~
 DECOMPILE_BCS_TO_BAF

 REPLACE_TEXTUALLY
~ActionOverride("Skie",LeaveParty())
    ActionOverride("Skie",ChangeAIScript("",DEFAULT))
    ActionOverride("Skie",ClearAllActions())
    ActionOverride("Skie",DestroySelf())~
~ActionOverride("Skie",ChangeAIScript("",OVERRIDE))~

 COMPILE_BAF_TO_BCS
//////////////////////////////////////////////////////////////
//#18-7 Xan
BEGIN @1807
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 1807

COPY_EXISTING ~ARAM00.BCS~ ~override~
 DECOMPILE_BCS_TO_BAF

 REPLACE_TEXTUALLY
~ActionOverride("Xan",LeaveParty())
    ActionOverride("Xan",ChangeAIScript("",DEFAULT))
    ActionOverride("Xan",ClearAllActions())
    ActionOverride("Xan",DestroySelf())~
~ActionOverride("Xan",LeaveParty())
    ActionOverride("Xan",ChangeAIScript("",DEFAULT))
    SetGlobal("XanPartyBG1","GLOBAL",1)
    // Waukeen's Promenade near Adventurers' Mart
    ActionOverride("Xan",MoveBetweenAreas("AR0700",[2174.1741],4))~

 COMPILE_BAF_TO_BCS

EXTEND_BOTTOM ~AR0700.BCS~ ~BGTTweak/18/aAR0700.BAF~
COMPILE ~BGTTweak\18\RemXan.D~
//////////////////////////////////////////////////////////////
//#18-8 Yeslick
BEGIN @1808
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 1808

COPY_EXISTING ~ARAM00.BCS~ ~override~
 DECOMPILE_BCS_TO_BAF

 REPLACE_TEXTUALLY
~ActionOverride("Yeslick",LeaveParty())
    ActionOverride("Yeslick",ChangeAIScript("",DEFAULT))
    ActionOverride("Yeslick",ClearAllActions())
    ActionOverride("Yeslick",DestroySelf())~
~ActionOverride("Yeslick",LeaveParty())
    ActionOverride("Yeslick",ChangeAIScript("",DEFAULT))
    SetGlobal("YeslickPartyBG1","GLOBAL",1)
    ActionOverride("Yeslick",ChangeAIScript("SBTYES",RACE))
    ActionOverride("Yeslick",MoveBetweenAreas("AR0900",[3445.1896],4))~

 COMPILE_BAF_TO_BCS
 
COMPILE ~BGTTweak\18\RemYesli.D~
//////////////////////////////////////////////////////////////
//Dark Side of the Sword Coast NPCs
//#18-9 Bub Snikt
BEGIN @1809
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~DSC001.ARE~) @8
DESIGNATED 1809

COPY_EXISTING ~ARAM00.BCS~ ~override~
 DECOMPILE_BCS_TO_BAF

 REPLACE_TEXTUALLY
~ActionOverride("DSBub",LeaveParty())
    ActionOverride("DSBub",ChangeAIScript("",DEFAULT))
    ActionOverride("DSBub",ClearAllActions())
    ActionOverride("DSBub",DestroySelf())~ ~~

 COMPILE_BAF_TO_BCS
//////////////////////////////////////////////////////////////
//#18-10 Conchobhair Strongblade
BEGIN @1810
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~DSC001.ARE~) @8
DESIGNATED 1810

COPY_EXISTING ~ARAM00.BCS~ ~override~
 DECOMPILE_BCS_TO_BAF

 REPLACE_TEXTUALLY
~ActionOverride("Conchobhair",LeaveParty())
    ActionOverride("Conchobhair",ChangeAIScript("",DEFAULT))
    ActionOverride("Conchobhair",ClearAllActions())
    ActionOverride("Conchobhair",DestroySelf())~ ~~

 COMPILE_BAF_TO_BCS
//////////////////////////////////////////////////////////////
//#18-11 Ferthgil Trollslayer
BEGIN @1811
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~DSC001.ARE~) @8
DESIGNATED 1811

COPY_EXISTING ~ARAM00.BCS~ ~override~
 DECOMPILE_BCS_TO_BAF

 REPLACE_TEXTUALLY
~ActionOverride("Ferthgil",LeaveParty())
    ActionOverride("Ferthgil",ChangeAIScript("",DEFAULT))
    ActionOverride("Ferthgil",ClearAllActions())
    ActionOverride("Ferthgil",DestroySelf())~ ~~

 COMPILE_BAF_TO_BCS
//////////////////////////////////////////////////////////////
//#18-12 Jet'laya
BEGIN @1812
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~DSC001.ARE~) @8
DESIGNATED 1812

COPY_EXISTING ~ARAM00.BCS~ ~override~
 DECOMPILE_BCS_TO_BAF

 REPLACE_TEXTUALLY
~ActionOverride("Jetlaya",LeaveParty())
    ActionOverride("Jetlaya",ChangeAIScript("",DEFAULT))
    ActionOverride("Jetlaya",ClearAllActions())
    ActionOverride("Jetlaya",DestroySelf())~ ~~

 COMPILE_BAF_TO_BCS
//////////////////////////////////////////////////////////////
//#18-13 Keiria Silverstring
BEGIN @1813
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~DSC001.ARE~) @8
DESIGNATED 1813

COPY_EXISTING ~ARAM00.BCS~ ~override~
 DECOMPILE_BCS_TO_BAF

 REPLACE_TEXTUALLY
~ActionOverride("Keiria",LeaveParty())
    ActionOverride("Keiria",ChangeAIScript("",DEFAULT))
    ActionOverride("Keiria",ClearAllActions())
    ActionOverride("Keiria",DestroySelf())~ ~~

 COMPILE_BAF_TO_BCS
//////////////////////////////////////////////////////////////
//#18-14 Skeezer Lumpkin VI
BEGIN @1814
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~DSC001.ARE~) @8
DESIGNATED 1814

COPY_EXISTING ~ARAM00.BCS~ ~override~
 DECOMPILE_BCS_TO_BAF

 REPLACE_TEXTUALLY
~ActionOverride("Skeezer",LeaveParty())
    ActionOverride("Skeezer",ChangeAIScript("",DEFAULT))
    ActionOverride("Skeezer",ClearAllActions())
    ActionOverride("Skeezer",DestroySelf())~ ~~

 COMPILE_BAF_TO_BCS
//////////////////////////////////////////////////////////////
//Northern Tales of the Sword Coast NPCs
//#18-15 Will Scarlet O'Hara
BEGIN @1815
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AR01PB.ARE~) @9
DESIGNATED 1815

COPY_EXISTING ~ARAM00.BCS~ ~override~
 DECOMPILE_BCS_TO_BAF

 REPLACE_TEXTUALLY
~ActionOverride("Will",LeaveParty())
    ActionOverride("Will",ChangeAIScript("",DEFAULT))
    ActionOverride("Will",ClearAllActions())
    ActionOverride("Will",DestroySelf())~ ~~

 COMPILE_BAF_TO_BCS
//////////////////////////////////////////////////////////////



//#19 Restore BG2 XP bonus for traps, locks, and scrolls//////
BEGIN @1900
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 1900

COPY ~BGTTweak/19/xpbonus.2da~ ~override/xpbonus.2da~
//////////////////////////////////////////////////////////////



//#20 Protagonist's biography modifications///////////////////
BEGIN @2001 SUBCOMPONENT @2000
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 2001

COPY_EXISTING ~AR0015.BCS~ ~override/AR0015.BCS~
 DECOMPILE_BCS_TO_BAF
 REPLACE_TEXTUALLY ~CreateCreatureObject("A6BIO",Player1,0,0,0)~ ~~
 REPLACE_TEXTUALLY ~AddXPObject(Player1,-1)~ ~AddXPObxject(Player1,-1)
CreateCreatureObject("A6BIO",Player1,0,0,0)~
 REPLACE_TEXTUALLY ~AddXPObxject(Player1,-1)~ ~AddXPObject(Player1,-1)~
 COMPILE_BAF_TO_BCS
//////////////////////////////////////////////////////////////
BEGIN @2002 SUBCOMPONENT @2000
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 2002

EXTEND_TOP ~A6BIO.BCS~ ~BGTTweak/21/aA6BIO.BAF~

COPY_EXISTING ~AR0602.BCS~ ~override/AR0602.BCS~
  DECOMPILE_BCS_TO_BAF
  REPLACE_TEXTUALLY ~ActionOverride(Player1,SetPlayerSound(Myself,15881,EXISTANCE5))~ ~~
  REPLACE_TEXTUALLY ~TakePartyGold(2147483647)~ ~TakePartyGoxld(2147483647)
CreateCreatureObject("A6BIO",Player1,0,0,0)~
  REPLACE_TEXTUALLY ~TakePartyGoxld(2147483647)~ ~TakePartyGold(2147483647)~
  COMPILE_BAF_TO_BCS
//////////////////////////////////////////////////////////////
/* Why revert a biography when you cannot even make a custom biography?
BEGIN @2003 //SUBCOMPONENT @2000
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 2003

STRING_SET ~33347~ @2005

EXTEND_BOTTOM ~BALDUR.BCS~ ~BGTTwweak/21/aBALDUR.BAF~
//////////////////////////////////////////////////////////////
BEGIN @2004 //SUBCOMPONENT @2000
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 2004

STRING_SET ~33347~ @2005

EXTEND_TOP ~A6BIO.BCS~ ~BGTTweak/21/aA6BIO.BAF~

COPY_EXISTING ~AR0602.BCS~ ~override/AR0602.BCS~
  DECOMPILE_BCS_TO_BAF
  REPLACE_TEXTUALLY ~ActionOverride(Player1,SetPlayerSound(Myself,15881,EXISTANCE5)~ ~~
  REPLACE_TEXTUALLY ~TakePartyGold(2147483647)
    ActionOverride(Player1,DestroyAllEquipment())~ ~TakePartyGold(2147483647)
    CreateCreatureObject("A6BIO",Player1,0,0,0)
    ActionOverride(Player1,DestroyAllEquipment())~
  COMPILE_BAF_TO_BCS

EXTEND_BOTTOM ~BALDUR.BCS~ ~BGTTwweak/21/aBALDUR.BAF~
*/
/////////////////////////////////////////////////////////////



//#21 Exotic Weapons For Taerom//////////////////////
BEGIN @2100
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 2100

COPY_EXISTING ~TAERUM.STO~ ~override/TAERUM.STO~
  ADD_STORE_ITEM ~SW1H43~ #0 #0 #0 ~IDENTIFIED~ #2 //Katana
  ADD_STORE_ITEM ~SW1H46~ #0 #0 #0 ~IDENTIFIED~ #2 //Wazikashi
  ADD_STORE_ITEM ~SW1H48~ #0 #0 #0 ~IDENTIFIED~ #2 //Ninja-to
/////////////////////////////////////////////////////////////



//#22 Item BG1-ification/////////////////////////////////////
//Price changes
BEGIN @2200
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 2200

COPY_EXISTING ~AMUL17.ITM~ ~override/AMUL17.ITM~
  WRITE_LONG 0x34 15000 //Price

COPY_EXISTING ~AROW02.ITM~ ~override/AROW02.ITM~
  WRITE_LONG 0x34 10 //Price

COPY_EXISTING ~AROW04.ITM~ ~override/AROW04.ITM~
  WRITE_LONG 0x34 50 //Price

COPY_EXISTING ~AROW05.ITM~ ~override/AROW05.ITM~
  WRITE_LONG 0x34 50 //Price

COPY_EXISTING ~AROW08.ITM~ ~override/AROW08.ITM~
  WRITE_LONG 0x34 25 //Price

COPY_EXISTING ~AROW09.ITM~ ~override/AROW09.ITM~
  WRITE_LONG 0x34 30 //Price

COPY_EXISTING ~AROW11.ITM~ ~override/AROW11.ITM~
  WRITE_LONG 0x34 18 //Price

COPY_EXISTING ~BOLT02.ITM~ ~override/BOLT02.ITM~
  WRITE_LONG 0x34 10 //Price

COPY_EXISTING ~BOLT06.ITM~ ~override/BOLT06.ITM~
  WRITE_LONG 0x34 15 //Price

COPY_EXISTING ~BOW06.ITM~ ~override/BOW06.ITM~
  WRITE_LONG 0x34 1500 //Price

COPY_EXISTING ~BRAC01.ITM~ ~override/BRAC01.ITM~
  WRITE_LONG 0x34 3000 //Price

COPY_EXISTING ~BRAC02.ITM~ ~override/BRAC02.ITM~
  WRITE_LONG 0x34 3500 //Price

COPY_EXISTING ~BRAC03.ITM~ ~override/BRAC03.ITM~
  WRITE_LONG 0x34 4000 //Price

COPY_EXISTING ~BRAC04.ITM~ ~override/BRAC04.ITM~
  WRITE_LONG 0x34 5000 //Price

COPY_EXISTING ~BRAC06.ITM~ ~override/BRAC06.ITM~
  WRITE_LONG 0x34 9000 //Price

COPY_EXISTING ~BRAC07.ITM~ ~override/BRAC07.ITM~
  WRITE_LONG 0x34 7000 //Price

COPY_EXISTING ~CLCK02.ITM~ ~override/CLCK02.ITM~
  WRITE_LONG 0x34 9000 //Price

COPY_EXISTING ~CLCK05.ITM~ ~override/CLCK05.ITM~
  WRITE_LONG 0x34 16000 //Price

COPY_EXISTING ~CLCK07.ITM~ ~override/CLCK07.ITM~
  WRITE_LONG 0x34 1500 //Price

COPY_EXISTING ~CLCK17.ITM~ ~override/CLCK17.ITM~
  WRITE_LONG 0x34 10500 //Price

COPY_EXISTING ~HELM07.ITM~ ~override/HELM07.ITM~
  WRITE_LONG 0x34 14000 //Price

COPY_EXISTING ~MISC73.ITM~ ~override/MISC73.ITM~
  WRITE_LONG 0x34 18000 //Price

COPY_EXISTING ~RING03.ITM~ ~override/RING03.ITM~
  WRITE_LONG 0x34 5000 //Price

COPY_EXISTING ~RING05.ITM~ ~override/RING05.ITM~
  WRITE_LONG 0x34 20000 //Price

COPY_EXISTING ~RING06.ITM~ ~override/RING06.ITM~
  WRITE_LONG 0x34 3000 //Price

COPY_EXISTING ~RING07.ITM~ ~override/RING07.ITM~
  WRITE_LONG 0x34 9000 //Price

COPY_EXISTING ~RING09.ITM~ ~override/RING09.ITM~
  WRITE_LONG 0x34 10000 //Price

COPY_EXISTING ~RING20.ITM~ ~override/RING20.ITM~
  WRITE_LONG 0x34 5000 //Price

COPY_EXISTING ~RING22.ITM~ ~override/RING22.ITM~
  WRITE_LONG 0x34 10000 //Price

COPY_EXISTING ~SCRL13.ITM~ ~override/SCRL13.ITM~
  WRITE_LONG 0x34 0 //Price

COPY_EXISTING ~SCRL14.ITM~ ~override/SCRL14.ITM~
  WRITE_LONG 0x34 0 //Price

COPY_EXISTING ~SCRL16.ITM~ ~override/SCRL16.ITM~
  WRITE_LONG 0x34 0 //Price

COPY_EXISTING ~SCRL1U.ITM~ ~override/SCRL1U.ITM~
  WRITE_LONG 0x34 1200 //Price

COPY_EXISTING ~SCRL1Y.ITM~ ~override/SCRL1Y.ITM~
  WRITE_LONG 0x34 1200 //Price

COPY_EXISTING ~SCRL1Z.ITM~ ~override/SCRL1Z.ITM~
  WRITE_LONG 0x34 1200 //Price

COPY_EXISTING ~SCRL2A.ITM~ ~override/SCRL2A.ITM~
  WRITE_LONG 0x34 1200 //Price

COPY_EXISTING ~SCRL2D.ITM~ ~override/SCRL2D.ITM~
  WRITE_LONG 0x34 500 //Price

COPY_EXISTING ~SCRL2E.ITM~ ~override/SCRL2E.ITM~
  WRITE_LONG 0x34 500 //Price

COPY_EXISTING ~SCRL2F.ITM~ ~override/SCRL2F.ITM~
  WRITE_LONG 0x34 500 //Price

COPY_EXISTING ~SCRL2G.ITM~ ~override/SCRL2G.ITM~
  WRITE_LONG 0x34 500 //Price

COPY_EXISTING ~SCRL2H.ITM~ ~override/SCRL2H.ITM~
  WRITE_LONG 0x34 500 //Price

COPY_EXISTING ~SCRL5H.ITM~ ~override/SCRL5H.ITM~
  WRITE_LONG 0x34 400 //Price

COPY_EXISTING ~SCRL5I.ITM~ ~override/SCRL5I.ITM~
  WRITE_LONG 0x34 400 //Price

COPY_EXISTING ~SCRL5J.ITM~ ~override/SCRL5J.ITM~
  WRITE_LONG 0x34 400 //Price

COPY_EXISTING ~SCRL5K.ITM~ ~override/SCRL5K.ITM~
  WRITE_LONG 0x34 400 //Price

COPY_EXISTING ~SCRL5L.ITM~ ~override/SCRL5L.ITM~
  WRITE_LONG 0x34 400 //Price

COPY_EXISTING ~SCRL5M.ITM~ ~override/SCRL5M.ITM~
  WRITE_LONG 0x34 400 //Price

COPY_EXISTING ~SCRL5N.ITM~ ~override/SCRL5N.ITM~
  WRITE_LONG 0x34 500 //Price

COPY_EXISTING ~SCRL5O.ITM~ ~override/SCRL5O.ITM~
  WRITE_LONG 0x34 500 //Price

COPY_EXISTING ~SCRL5P.ITM~ ~override/SCRL5P.ITM~
  WRITE_LONG 0x34 500 //Price

COPY_EXISTING ~SCRL5Q.ITM~ ~override/SCRL5Q.ITM~
  WRITE_LONG 0x34 500 //Price

COPY_EXISTING ~SCRL63.ITM~ ~override/SCRL63.ITM~
  WRITE_LONG 0x34 500 //Price

COPY_EXISTING ~STAF06.ITM~ ~override/STAF06.ITM~
  WRITE_LONG 0x34 2900 //Price

COPY_EXISTING ~SW1H09.ITM~ ~override/SW1H09.ITM~
  WRITE_LONG 0x34 4000 //Price

COPY_EXISTING ~SW1H22.ITM~ ~override/SW1H22.ITM~
  WRITE_LONG 0x34 1300 //Price

COPY_EXISTING ~SW1H23.ITM~ ~override/SW1H23.ITM~
  WRITE_LONG 0x34 3000 //Price

COPY_EXISTING ~SW2H02.ITM~ ~override/SW2H02.ITM~
  WRITE_LONG 0x34 1500 //Price

COPY_EXISTING ~WAND02.ITM~ ~override/WAND02.ITM~
  WRITE_LONG 0x34 10000 //Price

COPY_EXISTING ~WAND03.ITM~ ~override/WAND03.ITM~
  WRITE_LONG 0x34 10000 //Price

COPY_EXISTING ~WAND04.ITM~ ~override/WAND04.ITM~
  WRITE_LONG 0x34 12500 //Price

COPY_EXISTING ~WAND05.ITM~ ~override/WAND05.ITM~
  WRITE_LONG 0x34 22000 //Price

COPY_EXISTING ~WAND06.ITM~ ~override/WAND06.ITM~
  WRITE_LONG 0x34 15000 //Price

COPY_EXISTING ~WAND07.ITM~ ~override/WAND07.ITM~
  WRITE_LONG 0x34 20000 //Price

COPY_EXISTING ~WAND10.ITM~ ~override/WAND10.ITM~
  WRITE_LONG 0x34 25000 //Price

COPY_EXISTING ~XBOW03.ITM~ ~override/XBOW03.ITM~
  WRITE_LONG 0x34 8000 //Price

COPY_EXISTING ~XBOW06.ITM~ ~override/XBOW06.ITM~
  WRITE_LONG 0x34 8000 //Price
/////////////////////////////////////////////////////////////
//Reduced stack size from 40 to 20
BEGIN @2201
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 2201

COPY_EXISTING ~AROW01.ITM~ ~override/AROW01.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~AROW02.ITM~ ~override/AROW02.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~AROW03.ITM~ ~override/AROW03.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~AROW04.ITM~ ~override/AROW04.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~AROW05.ITM~ ~override/AROW05.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~AROW06.ITM~ ~override/AROW06.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~AROW07.ITM~ ~override/AROW07.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~AROW08.ITM~ ~override/AROW08.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~AROW09.ITM~ ~override/AROW09.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~AROW10.ITM~ ~override/AROW10.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~AROW11.ITM~ ~override/AROW11.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

//undroppable
//COPY_EXISTING ~AROW12.ITM~ ~override/AROW12.ITM~
//  WRITE_SHORT 0x38 20 //Max in stack

//IdDesc different, but undroppable
//COPY_EXISTING ~AROW16.ITM~ ~override/AROW16.ITM~
//  WRITE_SHORT 0x38 20 //Max in stack

//IdDesc different, but undroppable
//COPY_EXISTING ~AROWKC.ITM~ ~override/AROWKC.ITM~
//  WRITE_SHORT 0x38 20 //Max in stack

//IdDesc different, but undroppable
//COPY_EXISTING ~ARROPHE2.ITM~ ~override/ARROPHE2.ITM~
//  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~BOLT01.ITM~ ~override/BOLT01.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~BOLT02.ITM~ ~override/BOLT02.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~BOLT03.ITM~ ~override/BOLT03.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~BOLT04.ITM~ ~override/BOLT04.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~BOLT05.ITM~ ~override/BOLT05.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~BOLT06.ITM~ ~override/BOLT06.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~BULL01.ITM~ ~override/BULL01.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~BULL02.ITM~ ~override/BULL02.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~BULL03.ITM~ ~override/BULL03.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~DART01.ITM~ ~override/DART01.ITM~
  WRITE_SHORT 0x38 20 //Max in stack

COPY_EXISTING ~IAROW01.ITM~ ~override/IAROW01.ITM~
  WRITE_SHORT 0x38 20 //Max in stack
/////////////////////////////////////////////////////////////
//Lore changes
BEGIN @2202
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 2202

COPY_EXISTING ~AX1H07.ITM~ ~override/AX1H07.ITM~
  WRITE_SHORT 0x42 65 //Lore

COPY_EXISTING ~BLUN09.ITM~ ~override/BLUN09.ITM~
  WRITE_SHORT 0x42 65 //Lore

COPY_EXISTING ~BLUN11.ITM~ ~override/BLUN11.ITM~
  WRITE_SHORT 0x42 40 //Lore

COPY_EXISTING ~BOW06.ITM~ ~override/BOW06.ITM~
  WRITE_SHORT 0x42 25 //Lore

COPY_EXISTING ~CHAN03.ITM~ ~override/CHAN03.ITM~
  WRITE_SHORT 0x42 65 //Lore

COPY_EXISTING ~CHAN07.ITM~ ~override/CHAN07.ITM~
  WRITE_SHORT 0x42 75 //Lore

COPY_EXISTING ~CLCK07.ITM~ ~override/CLCK07.ITM~
  WRITE_SHORT 0x42 0 //Lore

COPY_EXISTING ~DAGG04.ITM~ ~override/DAGG04.ITM~
  WRITE_SHORT 0x42 60 //Lore

COPY_EXISTING ~HALB03.ITM~ ~override/HALB03.ITM~
  WRITE_SHORT 0x42 60 //Lore

COPY_EXISTING ~HELM03.ITM~ ~override/HELM03.ITM~
  WRITE_SHORT 0x42 40 //Lore

COPY_EXISTING ~HELM07.ITM~ ~override/HELM07.ITM~
  WRITE_SHORT 0x42 100 //Lore

COPY_EXISTING ~LEAT03.ITM~ ~override/LEAT03.ITM~
  WRITE_SHORT 0x42 60 //Lore

COPY_EXISTING ~LEAT06.ITM~ ~override/LEAT06.ITM~
  WRITE_SHORT 0x42 100 //Lore

COPY_EXISTING ~MISC72.ITM~ ~override/MISC72.ITM~
  WRITE_SHORT 0x42 20 //Lore

COPY_EXISTING ~PLAT02.ITM~ ~override/PLAT02.ITM~
  WRITE_SHORT 0x42 40 //Lore

COPY_EXISTING ~SLNG03.ITM~ ~override/SLNG03.ITM~
  WRITE_SHORT 0x42 45 //Lore

COPY_EXISTING ~STAF06.ITM~ ~override/STAF06.ITM~
  WRITE_SHORT 0x42 25 //Lore

COPY_EXISTING ~STAF07.ITM~ ~override/STAF07.ITM~
  WRITE_SHORT 0x42 65 //Lore

COPY_EXISTING ~SW1H06.ITM~ ~override/SW1H06.ITM~
  WRITE_SHORT 0x42 60 //Lore

COPY_EXISTING ~SW1H24.ITM~ ~override/SW1H24.ITM~
  WRITE_SHORT 0x42 70 //Lore
/////////////////////////////////////////////////////////////
//Scroll casting level changes
BEGIN @2203
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 2203

COPY_EXISTING ~SCRL1B.ITM~ ~override/SCRL1B.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL1C.ITM~ ~override/SCRL1C.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL1D.ITM~ ~override/SCRL1D.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL1E.ITM~ ~override/SCRL1E.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL1F.ITM~ ~override/SCRL1F.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL1G.ITM~ ~override/SCRL1G.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL1H.ITM~ ~override/SCRL1H.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL1I.ITM~ ~override/SCRL1I.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL1K.ITM~ ~override/SCRL1K.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL1L.ITM~ ~override/SCRL1L.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL1M.ITM~ ~override/SCRL1M.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL1N.ITM~ ~override/SCRL1N.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL1O.ITM~ ~override/SCRL1O.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL1P.ITM~ ~override/SCRL1P.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL1Q.ITM~ ~override/SCRL1Q.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL1S.ITM~ ~override/SCRL1S.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL1T.ITM~ ~override/SCRL1T.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL1U.ITM~ ~override/SCRL1U.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 5 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL1Y.ITM~ ~override/SCRL1Y.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 5 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL2A.ITM~ ~override/SCRL2A.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 5 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL2D.ITM~ ~override/SCRL2D.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 5 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL2E.ITM~ ~override/SCRL2E.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 5 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL2F.ITM~ ~override/SCRL2F.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 5 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL2G.ITM~ ~override/SCRL2G.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 5 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL2H.ITM~ ~override/SCRL2H.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 1 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL56.ITM~ ~override/SCRL56.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 7 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL58.ITM~ ~override/SCRL58.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL59.ITM~ ~override/SCRL59.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 7 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL5A.ITM~ ~override/SCRL5A.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 7 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL5B.ITM~ ~override/SCRL5B.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 7 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL5C.ITM~ ~override/SCRL5C.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 7 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL5D.ITM~ ~override/SCRL5D.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 7 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL5E.ITM~ ~override/SCRL5E.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 9 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL5F.ITM~ ~override/SCRL5F.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 9 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL5G.ITM~ ~override/SCRL5G.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 7 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL5H.ITM~ ~override/SCRL5H.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 7 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL5I.ITM~ ~override/SCRL5I.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 7 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL5J.ITM~ ~override/SCRL5J.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 7 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL5K.ITM~ ~override/SCRL5K.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 7 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL5L.ITM~ ~override/SCRL5L.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 7 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL5M.ITM~ ~override/SCRL5M.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 7 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL5N.ITM~ ~override/SCRL5N.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 9 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL5O.ITM~ ~override/SCRL5O.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 9 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL5P.ITM~ ~override/SCRL5P.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 9 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL5Q.ITM~ ~override/SCRL5Q.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 9 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL61.ITM~ ~override/SCRL61.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 9 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL62.ITM~ ~override/SCRL62.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 9 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL66.ITM~ ~override/SCRL66.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL68.ITM~ ~override/SCRL68.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL69.ITM~ ~override/SCRL69.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL70.ITM~ ~override/SCRL70.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL71.ITM~ ~override/SCRL71.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL72.ITM~ ~override/SCRL72.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL73.ITM~ ~override/SCRL73.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL76.ITM~ ~override/SCRL76.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL77.ITM~ ~override/SCRL77.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL78.ITM~ ~override/SCRL78.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL79.ITM~ ~override/SCRL79.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL80.ITM~ ~override/SCRL80.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL81.ITM~ ~override/SCRL81.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL82.ITM~ ~override/SCRL82.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL83.ITM~ ~override/SCRL83.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL84.ITM~ ~override/SCRL84.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL85.ITM~ ~override/SCRL85.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL86.ITM~ ~override/SCRL86.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL87.ITM~ ~override/SCRL87.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL89.ITM~ ~override/SCRL89.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL90.ITM~ ~override/SCRL90.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL91.ITM~ ~override/SCRL91.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL92.ITM~ ~override/SCRL92.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL93.ITM~ ~override/SCRL93.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL94.ITM~ ~override/SCRL94.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL95.ITM~ ~override/SCRL95.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL96.ITM~ ~override/SCRL96.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL97.ITM~ ~override/SCRL97.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL98.ITM~ ~override/SCRL98.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRL99.ITM~ ~override/SCRL99.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 6 //Param2 [Cast at level...]
    END
  END
/////////////////////////////////////////////////////////////
//Item behaviour changes
BEGIN @2204
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 2204

COPY_EXISTING ~AROW02.ITM~ ~override/AROW02.ITM~
  SAY IDENTIFIED_DESC @2301 //16297

  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 2) BEGIN //Ranged
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x1A) 1 //Ability damage bonus
    END
  END

COPY_EXISTING ~AROW04.ITM~ ~override/AROW04.ITM~
  SAY IDENTIFIED_DESC @2302 //17536

  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    READ_SHORT (%fx_off% + %i% * 0x30 + 0xA) fx_param2
    PATCH_IF (%fx_type% = 12 && %fx_param2% = 1) BEGIN //Damage && ACID
      WRITE_SHORT (%fx_off% + %i% * 0x30 + 0x1C) 2 //#Dice
      WRITE_SHORT (%fx_off% + %i% * 0x30 + 0x20) 6 //Dice size
    END
  END

COPY_EXISTING ~AROW08.ITM~ ~override/AROW08.ITM~
  SAY IDENTIFIED_DESC @2303 //17540

  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
    //BG1: Ability damage bonus 2 but not in IdDesc
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    READ_SHORT (%fx_off% + %i% * 0x30 + 0xA) fx_param2
    PATCH_IF (%fx_type% = 12 && %fx_param2% = 8) BEGIN //Damage && FIRE
      WRITE_SHORT (%fx_off% + %i% * 0x30 + 0x20) 6 //Dice size
    END
  END

COPY_EXISTING ~AROW09.ITM~ ~override/AROW09.ITM~
  SAY IDENTIFIED_DESC @2304 //17542

  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    READ_SHORT (%fx_off% + %i% * 0x30 + 0xA) fx_param2
    PATCH_IF (%fx_type% = 12 && %fx_param2% = 2) BEGIN //Damage && COLD
      WRITE_SHORT (%fx_off% + %i% * 0x30 + 0x20) 6 //Dice size
    END
  END

COPY_EXISTING ~AROW11.ITM~ ~override/AROW11.ITM~
  SAY IDENTIFIED_DESC @2305 //17534

  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 2) BEGIN //Ranged
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x1A) 2 //Ability damage bonus
    END
  END

//BG2 has correct description
//COPY_EXISTING ~AX1H02.ITM~ ~override/AX1H02.ITM~

/*COPY_EXISTING ~AX1H04.ITM~ ~override/AX1H04.ITM~
//  WRITE_LONG 0x4c 2 //Weight; but description says 5

  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 2) BEGIN //Ranged
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x36) 1 //Is Missile = TRUE
    END
  END*/

/*COPY_EXISTING ~AX1H05.ITM~ ~override/AX1H05.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 2) BEGIN //Ranged
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x36) 1 //Is Missile = TRUE
    END
  END*/

//converted by old Tutu versions, but actually unused
//COPY_EXISTING ~BLUN10.ITM~ ~override/BLUN10.ITM~

COPY_EXISTING ~BOLT02.ITM~ ~override/BOLT02.ITM~
  SAY IDENTIFIED_DESC @2306 //19353

  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 2) BEGIN //Ranged
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x1A) 1 //Ability damage bonus
    END
  END

COPY_EXISTING ~BOLT06.ITM~ ~override/BOLT06.ITM~
  SAY IDENTIFIED_DESC @2307 //19358

  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 2) BEGIN //Ranged
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x1A) 2 //Ability damage bonus
    END
  END

COPY_EXISTING ~BOOT02.ITM~ ~override/BOOT02.ITM~
  SAY IDENTIFIED_DESC @2308 //7376

  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 275) BEGIN //Hide in Shadow bonus
      WRITE_SHORT (%fx_off% + %i% * 0x30 + 0x4) 0 //Value; disable the bonus
    END

    PATCH_IF (%fx_type% = 59) BEGIN //Stealth bonus
      WRITE_SHORT (%fx_off% + %i% * 0x30 + 0x4) 35 //Value
    END
  END

//COPY_EXISTING ~BOOT06.ITM~ ~override/BOOT06.ITM~
//  WRITE_LONG 0x4c 5 //Weight; but description says 4

COPY_EXISTING ~BOW01.ITM~ ~override/BOW01.ITM~
  SAY UNIDENTIFIED_DESC @2309 //6858

  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 4) BEGIN //Launcher
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x1A) 2 //Ability damage bonus
    END
  END

COPY_EXISTING ~BOW02.ITM~ ~override/BOW02.ITM~
  SAY UNIDENTIFIED_DESC @2309 //6858
  SAY IDENTIFIED_DESC @2310 //16288
  WRITE_BYTE 0x26 8 //Minimum strength

  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 4) BEGIN //Launcher
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x1A) 3 //Ability damage bonus
    END
  END

COPY_EXISTING ~BOW04.ITM~ ~override/BOW04.ITM~
  SAY IDENTIFIED_DESC @2311 //17643

  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 4) BEGIN //Launcher
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x1A) 1 //Ability damage bonus
    END
  END

COPY_EXISTING ~BOW05.ITM~ ~override/BOW05.ITM~
  READ_STRREF UNIDENTIFIED_DESC temp_strref
  INNER_PATCH_SAVE new_strref "%temp_strref%" BEGIN
    REPLACE_TEXTUALLY ~ 3 ~ ~ 6 ~ //Change description to require 6 strength
  END
  SAY_EVALUATED UNIDENTIFIED_DESC "%new_strref%"

  WRITE_BYTE 0x26 6 //Minimum strength

COPY_EXISTING ~BOW06.ITM~ ~override/BOW06.ITM~
  READ_STRREF UNIDENTIFIED_DESC temp_strref
  INNER_PATCH_SAVE new_strref "%temp_strref%" BEGIN
    REPLACE_TEXTUALLY ~ 3 ~ ~ 6 ~ //Change description to require 6 strength
  END
  SAY_EVALUATED UNIDENTIFIED_DESC "%new_strref%"

  READ_STRREF IDENTIFIED_DESC temp_strref
  INNER_PATCH_SAVE new_strref "%temp_strref%" BEGIN
    REPLACE_TEXTUALLY ~ 3 ~ ~ 6 ~ //Change description to require 6 strength
  END
  SAY_EVALUATED IDENTIFIED_DESC "%new_strref%"

  WRITE_BYTE 0x26 6 //Minimum strength
  WRITE_LONG 0x4c 2 //Weight

  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 4) BEGIN //Launcher
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0xE) 75 //Ability Range
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x1A) 1 //Ability damage bonus
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x1C) 4 //Ability Damagetype = MISSILE
    END
  END

COPY_EXISTING ~CHAN02.ITM~ ~override/CHAN02.ITM~
  SAY IDENTIFIED_DESC @2312 //16272
  WRITE_LONG 0x4c 20 //Weight

COPY_EXISTING ~CHAN03.ITM~ ~override/CHAN03.ITM~
  SAY IDENTIFIED_DESC @2313 //6676

  WRITE_BYTE 0x26 7 //Minimum strength

COPY_EXISTING ~CHAN05.ITM~ ~override/CHAN05.ITM~
  SAY IDENTIFIED_DESC @2314 //16273
  WRITE_LONG 0x4c 20 //Weight

COPY_EXISTING ~CHAN06.ITM~ ~override/CHAN06.ITM~
  SAY IDENTIFIED_DESC @2315 //11059
  WRITE_BYTE 0x26 5 //Minimum strength

COPY_EXISTING ~CHAN07.ITM~ ~override/CHAN07.ITM~
  SAY IDENTIFIED_DESC @2316 //21303
  WRITE_BYTE 0x26 6 //Minimum strength

COPY_EXISTING ~CHILLT.ITM~ ~override/CHILLT.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 1) BEGIN //Melee
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x14) 5 //Ability to hit
    END
  END

COPY_EXISTING ~CLCK07.ITM~ ~override/CLCK07.ITM~
  SAY IDENTIFIED_DESC @2317 //17243

  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 3) BEGIN //Magical
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x22) 100 //#Charges
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x27) 0 //Item recharges? = Unknown
    END

    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 5) BEGIN //Charm creature
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x28) 0xFFFFFFFF //Save bonus = -1
    END
  END

//COPY_EXISTING ~DAGG04.ITM~ ~override/DAGG04.ITM~
//  WRITE_BYTE 0x26 4 //Minimum strength; but not consistent with daggers

/*COPY_EXISTING ~DAGG05.ITM~ ~override/DAGG05.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 2) BEGIN //Ranged
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x36) 1 //Is Missile = TRUE
    END
  END*/

COPY_EXISTING ~DART01.ITM~ ~override/DART01.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 2) BEGIN //Ranged
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x12) 2 //Speed
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x1C) 4 //Ability damage type = MISSILE
//      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x36) 1 //Is Missile = TRUE - this causes SKELET_B.CRE crash
    END
  END

/*COPY_EXISTING ~DART02.ITM~ ~override/DART02.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 2) BEGIN //Ranged
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x36) 1 //Is Missile = TRUE
    END
  END*/

/*COPY_EXISTING ~DART03.ITM~ ~override/DART03.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 2) BEGIN //Ranged
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x36) 1 //Is Missile = TRUE
    END
  END*/

/*COPY_EXISTING ~DART04.ITM~ ~override/DART04.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 2) BEGIN //Ranged
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x36) 1 //Is Missile = TRUE
    END
  END*/

COPY_EXISTING ~GHOST3.ITM~ ~override/GHOST3.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  INSERT_BYTES "%fx_off%" 0x30

  WRITE_SHORT "%fx_off%" 65 //Effect type = BLUR
  WRITE_BYTE ("%fx_off%" + 0x2) 1 //Effect target = SELF
  WRITE_BYTE ("%fx_off%" + 0x3) 1 //Power
  WRITE_BYTE ("%fx_off%" + 0xC) 2 //Timing mode = INSTANT/EQUIPPED
  WRITE_LONG ("%fx_off%" + 0x12) 100 //Probability 1

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x20) fx_abil_idx
    WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x20) ("%fx_abil_idx%" + 1)
  END

  SET fx_global_num += 1
  WRITE_SHORT 0x70 fx_global_num

  INSERT_BYTES "%fx_off%" 0x30

  WRITE_SHORT "%fx_off%" 16 //Effect type = HASTE
  WRITE_BYTE ("%fx_off%" + 0x2) 1 //Effect target = SELF
  WRITE_BYTE ("%fx_off%" + 0xC) 2 //Timing mode = INSTANT/EQUIPPED
  WRITE_LONG ("%fx_off%" + 0x12) 100 //Probability 1

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x20) fx_abil_idx
    WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x20) ("%fx_abil_idx%" + 1)
  END

  SET fx_global_num += 1
  WRITE_SHORT 0x70 fx_global_num

COPY_EXISTING ~GHOUL1.ITM~ ~override/GHOUL1.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 1) BEGIN //Melee
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x1C) 1 //Ability damage type = PIERCING
    END

    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 109) BEGIN //Hold creature
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x8) 0x4 //Param2[1] [IDS target] = RACE.IDS
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 0x1 //Param2[2] [IDS target] = HUMAN
    END
  END

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    READ_BYTE (%abil_off% + %i% * 0x38 + 0x1E) abil_fx_num
    READ_BYTE (%abil_off% + %i% * 0x38 + 0x20) abil_fx_idx
    PATCH_IF ("%abil_type%" = 1 && "%abil_fx_num%" = 6) BEGIN
      SET abil_target = "%i%"
      SET abil_target_fx_num = "%abil_fx_num%"
      SET abil_target_fx_idx = "%abil_fx_idx%"
    END
  END

  INSERT_BYTES "%fx_off%" 0x30

  WRITE_SHORT ("%fx_off%" + "%abil_fx_idx%" * 0x30) 109 //Effect type = HOLD_CREATURE
  WRITE_BYTE ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0x2) 2 //Effect target = PRESET_TARGET
  WRITE_LONG ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0x4) 3 //Param2[2] [IDS target] = HALF_ELF
  WRITE_LONG ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0x8) 4 //Param2[1] [IDS target] = RACE.IDS
  WRITE_BYTE ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0xD) 1 //Dispel/Resistance = YES/NO
  WRITE_LONG ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0xE) 30 //Duration
  WRITE_LONG ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0x12) 100 //Probability 1
  WRITE_LONG ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0x24) 0b00100000 //Save type = vS_DEATH_POISON

  SET abil_target_fx_num += 1
  WRITE_SHORT ("%abil_off%" + "%abil_target%" * 0x28 + 0x1E) "%abil_target_fx_num%" //target ability #FX

  FOR (i = "%abil_target_fx_idx%" + 1; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x20) fx_abil_idx
    WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x20) ("%fx_abil_idx%" + 1)
  END

  INSERT_BYTES "%fx_off%" 0x30

  WRITE_SHORT ("%fx_off%" + "%abil_fx_idx%" * 0x30) 109 //Effect type = HOLD_CREATURE
  WRITE_BYTE ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0x2) 2 //Effect target = PRESET_TARGET
  WRITE_LONG ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0x4) 4 //Param2[2] [IDS target] = DWARF
  WRITE_LONG ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0x8) 4 //Param2[1] [IDS target] = RACE.IDS
  WRITE_BYTE ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0xD) 1 //Dispel/Resistance = YES/NO
  WRITE_LONG ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0xE) 30 //Duration
  WRITE_LONG ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0x12) 100 //Probability 1
  WRITE_LONG ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0x24) 0b00100000 //Save type = vS_DEATH_POISON

  SET abil_target_fx_num += 1
  WRITE_SHORT ("%abil_off%" + "%abil_target%" * 0x28 + 0x1E) "%abil_target_fx_num%" //target ability #FX

  FOR (i = "%abil_target_fx_idx%" + 1; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x20) fx_abil_idx
    WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x20) ("%fx_abil_idx%" + 1)
  END

  INSERT_BYTES "%fx_off%" 0x30

  WRITE_SHORT ("%fx_off%" + "%abil_fx_idx%" * 0x30) 109 //Effect type = HOLD_CREATURE
  WRITE_BYTE ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0x2) 2 //Effect target = PRESET_TARGET
  WRITE_LONG ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0x4) 5 //Param2[2] [IDS target] = HALFLING
  WRITE_LONG ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0x8) 4 //Param2[1] [IDS target] = RACE.IDS
  WRITE_BYTE ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0xD) 1 //Dispel/Resistance = YES/NO
  WRITE_LONG ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0xE) 30 //Duration
  WRITE_LONG ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0x12) 100 //Probability 1
  WRITE_LONG ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0x24) 0b00100000 //Save type = vS_DEATH_POISON

  SET abil_target_fx_num += 1
  WRITE_SHORT ("%abil_off%" + "%abil_target%" * 0x28 + 0x1E) "%abil_target_fx_num%" //target ability #FX

  FOR (i = "%abil_target_fx_idx%" + 1; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x20) fx_abil_idx
    WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x20) ("%fx_abil_idx%" + 1)
  END

  INSERT_BYTES "%fx_off%" 0x30

  WRITE_SHORT ("%fx_off%" + "%abil_fx_idx%" * 0x30) 109 //Effect type = HOLD_CREATURE
  WRITE_BYTE ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0x2) 2 //Effect target = PRESET_TARGET
  WRITE_LONG ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0x4) 6 //Param2[2] [IDS target] = GNOME
  WRITE_LONG ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0x8) 4 //Param2[1] [IDS target] = RACE.IDS
  WRITE_BYTE ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0xD) 1 //Dispel/Resistance = YES/NO
  WRITE_LONG ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0xE) 30 //Duration
  WRITE_LONG ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0x12) 100 //Probability 1
  WRITE_LONG ("%fx_off%" + "%abil_fx_idx%" * 0x30 + 0x24) 0b00100000 //Save type = vS_DEATH_POISON

  SET abil_target_fx_num += 1
  WRITE_SHORT ("%abil_off%" + "%abil_target%" * 0x28 + 0x1E) "%abil_target_fx_num%" //target ability #FX

  FOR (i = "%abil_target_fx_idx%" + 1; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x20) fx_abil_idx
    WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x20) ("%fx_abil_idx%" + 1)
  END

//BG2 version contains in Display String effect Param2 = 2, apparently irrelevant
COPY_EXISTING ~GHOULT.ITM~ ~override/GHOULT.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 1) BEGIN //Melee
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x14) 4 //Ability to hit
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x16) 6 //Ability dice size
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x18) 0 //Ability #Dice
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x26) 1 //Ability Allow STR bonus = FALSE
    END
  END

//COPY_EXISTING ~HALB03.ITM~ ~override/HALB03.ITM~
//  WRITE_BYTE 0x26 11 //Minimum strength; but not consistent with halberds

//COPY_EXISTING ~HAMM03.ITM~ ~override/HAMM03.ITM~
//  WRITE_BYTE 0x26 8 //Minimum strength; but not consistent with warhammers

//BG2 version is more accurate to description
//COPY_EXISTING ~HAMM04.ITM~ ~override/HAMM04.ITM~

COPY_EXISTING ~HELM14.ITM~ ~override/HELM14.ITM~
  SAY IDENTIFIED_DESC @2318 //21408

  READ_BYTE 0x18 flags
  WRITE_BYTE 0x18 (%flags% BOR 0b00000001) //Add Unsellable flag

COPY_EXISTING ~IMMUNE1.ITM~ ~override/IMMUNE1.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 120) BEGIN //Immunity to Weapons
      WRITE_BYTE (%fx_off% + %i% * 0x30 + 0x3) 1 //Power
    END
  END

COPY_EXISTING ~LEAT02.ITM~ ~override/LEAT02.ITM~
  SAY IDENTIFIED_DESC @2319 //16269

  WRITE_LONG 0x4c 10 //Weight

//BG2 has more accurate description
COPY_EXISTING ~LEAT10.ITM~ ~override/LEAT10.ITM~
  READ_STRREF UNIDENTIFIED_DESC temp_strref
  INNER_PATCH_SAVE new_strref "%temp_strref%" BEGIN
    REPLACE_TEXTUALLY ~ 6 ~ ~ 9 ~ //Change description to require 9 strength
    REPLACE_TEXTUALLY ~ -20~ ~ -30~ //Change description of move silently penalty magnitude
  END
  SAY_EVALUATED UNIDENTIFIED_DESC "%new_strref%"

  WRITE_BYTE 0x26 9 //Minimum strength

  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 59) BEGIN //Stealth bonus
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 0xFFFFFFE2 //Value = -30
    END
  END

//undroppable
//COPY_EXISTING ~MAGE03.ITM~ ~override/MAGE03.ITM~

//undroppable
//COPY_EXISTING ~MAGE05.ITM~ ~override/MAGE05.ITM~

//BG2 correctly categorises as a Book
//COPY_EXISTING ~MISC71.ITM~ ~override/MISC71.ITM~

COPY_EXISTING ~MISC97.ITM~ ~override/MISC97.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  DELETE_BYTES 0x72 ("%abil_num%" * 0x28 + "%fx_total_num%" * 0x30)

  WRITE_LONG 0x64 0x72
  WRITE_SHORT 0x68 0
  WRITE_LONG 0x6a 0x72
  WRITE_SHORT 0x70 0

COPY_EXISTING ~PLAT02.ITM~ ~override/PLAT02.ITM~
  SAY IDENTIFIED_DESC @2320 //6682
  WRITE_BYTE 0x26 11 //Minimum strength

COPY_EXISTING ~PLAT05.ITM~ ~override/PLAT05.ITM~
  SAY IDENTIFIED_DESC @2321 //6685

COPY_EXISTING ~PLAT06.ITM~ ~override/PLAT06.ITM~
  SAY IDENTIFIED_DESC @2322 //17489

//COPY_EXISTING ~POTN10.ITM~ ~override/POTN10.ITM~

COPY_EXISTING ~POTN17.ITM~ ~override/POTN17.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 79) BEGIN //Cure disease
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x20) 0 //Minimum level/Dicesize
    END
  END

//COPY_EXISTING ~POTN27.ITM~ ~override/POTN27.ITM~
//COPY_EXISTING ~POTN28.ITM~ ~override/POTN28.ITM~
//COPY_EXISTING ~POTN29.ITM~ ~override/POTN29.ITM~
//COPY_EXISTING ~POTN30.ITM~ ~override/POTN30.ITM~
//COPY_EXISTING ~POTN31.ITM~ ~override/POTN31.ITM~
//COPY_EXISTING ~POTN32.ITM~ ~override/POTN32.ITM~
//COPY_EXISTING ~POTN33.ITM~ ~override/POTN33.ITM~
//COPY_EXISTING ~POTN34.ITM~ ~override/POTN34.ITM~
//COPY_EXISTING ~POTN35.ITM~ ~override/POTN35.ITM~
//COPY_EXISTING ~POTN36.ITM~ ~override/POTN36.ITM~
//COPY_EXISTING ~POTN37.ITM~ ~override/POTN37.ITM~
//COPY_EXISTING ~POTN38.ITM~ ~override/POTN38.ITM~
//COPY_EXISTING ~POTN39.ITM~ ~override/POTN39.ITM~
//COPY_EXISTING ~POTN40.ITM~ ~override/POTN40.ITM~
//COPY_EXISTING ~POTN41.ITM~ ~override/POTN41.ITM~
//COPY_EXISTING ~POTN42.ITM~ ~override/POTN42.ITM~
//COPY_EXISTING ~POTN43.ITM~ ~override/POTN43.ITM~
//COPY_EXISTING ~POTN45.ITM~ ~override/POTN45.ITM~

COPY_EXISTING ~POTN46.ITM~ ~override/POTN46.ITM~
  WRITE_LONG 0x4c 0 //Weight

COPY_EXISTING ~REVENT1.ITM~ ~override/REVENT1.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 2) BEGIN //Ranged
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x18) 0 //#Dice
    END
  END

COPY_EXISTING ~RING05.ITM~ ~override/RING05.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 3) BEGIN //Magical
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x22) 8 //Ability #Charges
      WRITE_BYTE (%abil_off% + %i% * 0x38 + 0x24) 1 //Ability when drained = VANISH
      WRITE_BYTE (%abil_off% + %i% * 0x38 + 0x27) 0 //Ability item recharges? = DISABLED
    END
  END

COPY_EXISTING ~RING09.ITM~ ~override/RING09.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    WRITE_LONG (%fx_off% + %i% * 0x30 + 0xD) 0 //Dispel/Resistance = NO/NO
  END

COPY_EXISTING ~RINGWOLF.ITM~ ~override/RINGWOLF.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  INSERT_BYTES "%fx_off%" 0x30

  WRITE_SHORT "%fx_off%" 120 //Effect type = IMMUNITY_WEAPONS
  WRITE_BYTE ("%fx_off%" + 0x2) 1 //Effect target = SELF
  WRITE_BYTE ("%fx_off%" + 0x8) 4 //Param2 [Weapon type] = NONSILVER
  WRITE_BYTE ("%fx_off%" + 0xC) 2 //Timing mode = INSTANT/EQUIPPED
  WRITE_LONG ("%fx_off%" + 0x12) 100 //Probability 1

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x20) fx_abil_idx
    WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x20) ("%fx_abil_idx%" + 1)
  END

  SET fx_global_num += 1
  WRITE_SHORT 0x70 fx_global_num

COPY_EXISTING ~SCRL07.ITM~ ~override/SCRL07.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 3) BEGIN //Magical
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0xC) 5 //Ability target type = CASTER
    END
  END

//Difference in IdDesc 12 hours [BG1] vs. 10 turns (2 hours) [BG2]
//BG2 has the correct description
//COPY_EXISTING ~SCRL09.ITM~ ~override/SCRL09.ITM~

COPY_EXISTING ~SCRL10.ITM~ ~override/SCRL10.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 3) BEGIN //Magical
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0xC) 1 //Ability target type = LIVING_ACTOR
    END
  END

COPY_EXISTING ~SCRL11.ITM~ ~override/SCRL11.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 3) BEGIN //Magical
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0xC) 1 //Ability target type = LIVING_ACTOR
    END
  END

COPY_EXISTING ~SCRL12.ITM~ ~override/SCRL12.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 3) BEGIN //Magical
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0xC) 1 //Ability target type = LIVING_ACTOR
    END
  END

COPY_EXISTING ~SCRL18.ITM~ ~override/SCRL18.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 3) BEGIN //Magical
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0xC) 1 //Ability target type = LIVING_ACTOR
    END
  END

COPY_EXISTING ~SCRL1C.ITM~ ~override/SCRL1C.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x20) 0xFFFFFFFF //Minimum level/Dicesize = -1
    END
  END

COPY_EXISTING ~SCRL1F.ITM~ ~override/SCRL1F.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_BYTE (%fx_off% + %i% * 0x30 + 0xD) 0 //Dispel/Resistance = NO/NO
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x20) 0xFFFFFFFF //Minimum level/Dicesize = -1
    END
  END

COPY_EXISTING ~SCRL1G.ITM~ ~override/SCRL1G.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x20) 0xFFFFFFFF //Minimum level/Dicesize = -1
    END
  END

COPY_EXISTING ~SCRL1H.ITM~ ~override/SCRL1H.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38 + 0x20) abil_fx_idx
    PATCH_IF (%abil_type% = 3 && %abil_fx_idx% = 0) BEGIN //Magical; catch Casting ability
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0xC) 1 //Ability target type = LIVING_ACTOR
    END

    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 148) BEGIN //Cast spell (scroll)
      WRITE_LONG (%fx_off% + %i% * 0x30) 146 //Type = CAST_SPELL
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x2) 2 //Target = PRESET_TARGET
    END
  END

//Renamed to BG1SCRL1V.ITM
//COPY_EXISTING ~SCRL1V.ITM~ ~override/SCRL1V.ITM~

COPY_EXISTING ~SCRL3G.ITM~ ~override/SCRL3G.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38 + 0x20) abil_fx_idx
    PATCH_IF (%abil_type% = 3 && %abil_fx_idx% = 0) BEGIN //Magical; catch Casting ability
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0xC) 1 //Ability target type = LIVING_ACTOR
    END

    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x2) 2 //Target = PRESET_TARGET
    END
  END

//BG2 does not have this resource; need to copy over
//COPY_EXISTING ~SCRL5R.ITM~ ~override/SCRL5R.ITM~

COPY_EXISTING ~SCRL63.ITM~ ~override/SCRL63.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    PATCH_IF (%abil_type% = 3) BEGIN //Magical
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0xC) 1 //Ability target type = LIVING_ACTOR
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0xE) 1 //Ability range
    END

    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 146) BEGIN //Cast spell
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 7 //Param2 [Cast at level...]
    END
  END

COPY_EXISTING ~SCRLPET.ITM~ ~override/SCRLPET.ITM~
  WRITE_BYTE 0x2a 9 //Minimum intelligence

//COPY_EXISTING ~SGRASP.ITM~ ~override/SGRASP.ITM~

COPY_EXISTING ~SHAMMR.ITM~ ~override/SHAMMR.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 1) BEGIN //Melee
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x12) 2 //Ability speed
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x14) 4 //Ability to hit
      WRITE_BYTE (%abil_off% + %i% * 0x38 + 0x26) 0 //Ability allow STR bonus = FALSE
    END

    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 141 || %fx_type% = 174) BEGIN //Lighting effects || Play sound
      WRITE_BYTE (%fx_off% + %i% * 0x30 + 0xD) 0 //Dispel/Resistance = NO/NO
    END
  END

COPY_EXISTING ~SHLD06.ITM~ ~override/SHLD06.ITM~
  SAY IDENTIFIED_DESC @2323 //17659
  WRITE_BYTE 0x26 14 //Minimum strength

COPY_EXISTING ~SHLD07.ITM~ ~override/SHLD07.ITM~
  SAY IDENTIFIED_DESC @2324 //7358
  WRITE_BYTE 0x26 13 //Minimum strength

  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type

    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    READ_LONG (%fx_off% + %i% * 0x30 + 0x8) fx_param2
    PATCH_IF (%fx_type% = 0 && %fx_param2% = 0b00000010) BEGIN //AC bonus to missile weapons
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 5 //Effect Param1 [AC value]
    END
  END

COPY_EXISTING ~SLNG01.ITM~ ~override/SLNG01.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 4) BEGIN //Launcher
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x26) 1 //Ability Allow STR bonus = TRUE
    END
  END

COPY_EXISTING ~SLNG02.ITM~ ~override/SLNG02.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 4) BEGIN //Launcher
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x26) 1 //Ability Allow STR bonus = TRUE
    END
  END

COPY_EXISTING ~SLNG03.ITM~ ~override/SLNG03.ITM~
  SAY IDENTIFIED_DESC @2325 //23963

  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 4) BEGIN //Launcher
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x26) 1 //Ability Allow STR bonus = TRUE
    END
  END

//COPY_EXISTING ~SPER03.ITM~ ~override/SPER03.ITM~

COPY_EXISTING ~SPIDPH1.ITM~ ~override/SPIDPH1.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type

    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 25) BEGIN //Poison
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x4) 5 //Effect Param1 [Damage]
    END
  END

COPY_EXISTING ~STAF05.ITM~ ~override/STAF05.ITM~
  SAY IDENTIFIED_DESC @2326 //22020
  WRITE_BYTE 0x26 3 //Minimum strength

COPY_EXISTING ~STAF06.ITM~ ~override/STAF06.ITM~
  WRITE_BYTE 0x26 3 //Minimum strength
  READ_STRREF UNIDENTIFIED_DESC temp_strref
  INNER_PATCH_SAVE new_strref "%temp_strref%" BEGIN
    REPLACE_TEXTUALLY ~ 5 ~ ~ 3 ~ //Change description to require 3 strength
  END
  SAY_EVALUATED UNIDENTIFIED_DESC "%new_strref%"
  READ_STRREF IDENTIFIED_DESC temp_strref
  INNER_PATCH_SAVE new_strref "%temp_strref%" BEGIN
    REPLACE_TEXTUALLY ~ 5 ~ ~ 3 ~ //Change description to require 3 strength
  END
  SAY_EVALUATED IDENTIFIED_DESC "%new_strref%"

COPY_EXISTING ~STAF08.ITM~ ~override/STAF08.ITM~
  SAY NAME2 @2327 //23977
  SAY IDENTIFIED_DESC @2328 //23978

COPY_EXISTING ~SW1H03.ITM~ ~override/SW1H03.ITM~
  WRITE_BYTE 0x26 10 //Minimum strength
  READ_STRREF UNIDENTIFIED_DESC temp_strref
  INNER_PATCH_SAVE new_strref "%temp_strref%" BEGIN
    REPLACE_TEXTUALLY ~ 11 ~ ~ 10 ~ //Change description to require 10 strength
  END
  SAY_EVALUATED UNIDENTIFIED_DESC "%new_strref%"
  READ_STRREF IDENTIFIED_DESC temp_strref
  INNER_PATCH_SAVE new_strref "%temp_strref%" BEGIN
    REPLACE_TEXTUALLY ~ 11 ~ ~ 10 ~ //Change description to require 10 strength
  END
  SAY_EVALUATED IDENTIFIED_DESC "%new_strref%"

COPY_EXISTING ~SW1H06.ITM~ ~override/SW1H06.ITM~
  WRITE_BYTE 0x26 5 //Minimum strength
  READ_STRREF UNIDENTIFIED_DESC temp_strref
  INNER_PATCH_SAVE new_strref "%temp_strref%" BEGIN
    REPLACE_TEXTUALLY ~ 6 ~ ~ 5 ~ //Change description to require 5 strength
  END
  SAY_EVALUATED UNIDENTIFIED_DESC "%new_strref%"
  READ_STRREF IDENTIFIED_DESC temp_strref
  INNER_PATCH_SAVE new_strref "%temp_strref%" BEGIN
    REPLACE_TEXTUALLY ~ 6 ~ ~ 5 ~ //Change description to require 5 strength
  END
  SAY_EVALUATED IDENTIFIED_DESC "%new_strref%"

COPY_EXISTING ~SW1H09.ITM~ ~override/SW1H09.ITM~
  SAY IDENTIFIED_DESC @2329 //7347
  WRITE_BYTE 0x26 4 //Minimum strength

COPY_EXISTING ~SW1H10.ITM~ ~override/SW1H10.ITM~
  WRITE_BYTE 0x26 4 //Minimum strength
  READ_STRREF UNIDENTIFIED_DESC temp_strref
  INNER_PATCH_SAVE new_strref "%temp_strref%" BEGIN
    REPLACE_TEXTUALLY ~ 5 ~ ~ 4 ~ //Change description to require 4 strength
  END
  SAY_EVALUATED UNIDENTIFIED_DESC "%new_strref%"
  READ_STRREF IDENTIFIED_DESC temp_strref
  INNER_PATCH_SAVE new_strref "%temp_strref%" BEGIN
    REPLACE_TEXTUALLY ~ 5 ~ ~ 4 ~ //Change description to require 4 strength
  END
  SAY_EVALUATED IDENTIFIED_DESC "%new_strref%"

COPY_EXISTING ~SW1H14.ITM~ ~override/SW1H14.ITM~
  SAY IDENTIFIED_DESC @2330 //18976

COPY_EXISTING ~SW1H20.ITM~ ~override/SW1H20.ITM~
  READ_BYTE 0x20 flags
  WRITE_BYTE 0x20 (%flags% BOR 0b01001000) //Add Mage-Thief and Thief unusability flags

COPY_EXISTING ~SW1H22.ITM~ ~override/SW1H22.ITM~
  READ_BYTE 0x20 flags
  WRITE_BYTE 0x20 (%flags% BOR 0b01001000) //Add Mage-Thief and Thief unusability flags

COPY_EXISTING ~SW1H23.ITM~ ~override/SW1H23.ITM~
  READ_BYTE 0x20 flags
  WRITE_BYTE 0x20 (%flags% BOR 0b01001000) //Add Mage-Thief and Thief unusability flags

COPY_EXISTING ~SW1H24.ITM~ ~override/SW1H24.ITM~
  SAY IDENTIFIED_DESC @2331 //23970
  WRITE_BYTE 0x26 5 //Minimum strength

  READ_BYTE 0x19 flags
  WRITE_BYTE 0x19 (%flags% BOR 0b00000010) //Add Cold iron flag

COPY_EXISTING ~SW2H02.ITM~ ~override/SW2H02.ITM~
  WRITE_BYTE 0x26 13 //Minimum strength
  READ_STRREF UNIDENTIFIED_DESC temp_strref
  INNER_PATCH_SAVE new_strref "%temp_strref%" BEGIN
    REPLACE_TEXTUALLY ~ 14 ~ ~ 13 ~ //Change description to require 13 strength
  END
  SAY_EVALUATED UNIDENTIFIED_DESC "%new_strref%"
  READ_STRREF IDENTIFIED_DESC temp_strref
  INNER_PATCH_SAVE new_strref "%temp_strref%" BEGIN
    REPLACE_TEXTUALLY ~ 14 ~ ~ 13 ~ //Change description to require 13 strength
  END
  SAY_EVALUATED IDENTIFIED_DESC "%new_strref%"

COPY_EXISTING ~SW2H06.ITM~ ~override/SW2H06.ITM~
  WRITE_BYTE 0x26 13 //Minimum strength
  READ_STRREF UNIDENTIFIED_DESC temp_strref
  INNER_PATCH_SAVE new_strref "%temp_strref%" BEGIN
    REPLACE_TEXTUALLY ~ 14 ~ ~ 13 ~ //Change description to require 13 strength
  END
  SAY_EVALUATED UNIDENTIFIED_DESC "%new_strref%"
  READ_STRREF IDENTIFIED_DESC temp_strref
  INNER_PATCH_SAVE new_strref "%temp_strref%" BEGIN
    REPLACE_TEXTUALLY ~ 14 ~ ~ 13 ~ //Change description to require 13 strength
  END
  SAY_EVALUATED IDENTIFIED_DESC "%new_strref%"

//BG2 has a different SW2H07 and uses it; need to prefix with BG
//COPY_EXISTING ~SW2H07.ITM~ ~override/SW2H07.ITM~

COPY_EXISTING ~WAND03.ITM~ ~override/WAND03.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 12 || %fx_type% = 141) BEGIN //Damage or Lighting Effects
      WRITE_BYTE (%fx_off% + %i% * 0x30 + 0x3) 8 //Power
    END
    PATCH_IF (%fx_type% = 141) BEGIN //Lighting Effects
      WRITE_LONG (%fx_off% + %i% * 0x30 + 0x20) 0 //Minimum level/Dicesize
    END
  END

COPY_EXISTING ~WAND05.ITM~ ~override/WAND05.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x2A) abil_projectile_type
    PATCH_IF (%abil_type% = 3 && %abil_projectile_type% = 38) BEGIN //Magical
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0xE) 60 //Ability range
      READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) abil_0_fx_num
      READ_SHORT (%abil_off% + %i% * 0x38 + 0x20) abil_0_fx_idx
    END
    PATCH_IF (%abil_type% = 3 && %abil_projectile_type% = 109) BEGIN //Magical
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0xE) 80 //Ability range
      READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) abil_1_fx_num
      READ_SHORT (%abil_off% + %i% * 0x38 + 0x20) abil_1_fx_idx
    END
  END

  FOR (i = "%abil_0_fx_idx%"; i < "%abil_0_fx_idx%" + "%abil_0_fx_num%"; i += 1) BEGIN
    WRITE_BYTE (%fx_off% + %i% * 0x30 + 0x3) 4 //Power
  END

  FOR (i = "%abil_1_fx_idx%"; i < "%abil_1_fx_idx%" + "%abil_1_fx_num%"; i += 1) BEGIN
    WRITE_BYTE (%fx_off% + %i% * 0x30 + 0x3) 8 //Power
  END

//ProjectileType difference
COPY_EXISTING ~WAND06.ITM~ ~override/WAND06.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    PATCH_IF (%fx_type% = 12) BEGIN //Damage
      WRITE_BYTE (%fx_off% + %i% * 0x30 + 0x3) 8 //Power
    END
  END

COPY_EXISTING ~WAND07.ITM~ ~override/WAND07.ITM~
  SAY IDENTIFIED_DESC @2332 //17656

  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x2A) abil_projectile_type
    PATCH_IF (%abil_type% = 3) BEGIN //Magical
      WRITE_BYTE (%abil_off% + %i% * 0x38 + 0xD) 0 //Ability #Targets
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0xE) 60 //Ability range
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x22) 100 //Ability #Charges
    END

    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    READ_BYTE (%fx_off% + %i% * 0x30 + 0x24) fx_savetype
    PATCH_IF (%fx_type% = 12 && %fx_savetype% = 0b00001000) BEGIN //Damage && Save vs. Wands
      WRITE_BYTE (%fx_off% + %i% * 0x30 + 0x3) 4 //Power
      WRITE_SHORT (%fx_off% + %i% * 0x30 + 0x1C) 6 //#Dice
      WRITE_SHORT (%fx_off% + %i% * 0x30 + 0x20) 3 //Dice size
    END
    PATCH_IF (%fx_type% = 12 && %fx_savetype% = 0) BEGIN //Damage && No save
      WRITE_BYTE (%fx_off% + %i% * 0x30 + 0x3) 4 //Power
      WRITE_SHORT (%fx_off% + %i% * 0x30 + 0x1C) 6 //#Dice
      WRITE_SHORT (%fx_off% + %i% * 0x30 + 0x20) 3 //Dice size
    END
  END

COPY_EXISTING ~WAND08.ITM~ ~override/WAND08.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  READ_SHORT 0x70 fx_global_num
  
  SET fx_total_num = %fx_global_num%

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x2A) abil_projectile_type
    PATCH_IF (%abil_type% = 3) BEGIN //Magical
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0xE) 60 //Ability range
    END

    READ_SHORT (%abil_off% + %i% * 0x38 + 0x1E) fx_abil_num
    SET fx_total_num += %fx_abil_num%
  END

  FOR (i = 0; i < "%fx_total_num%"; i += 1) BEGIN
    READ_SHORT (%fx_off% + %i% * 0x30) fx_type
    READ_BYTE (%fx_off% + %i% * 0x30 + 0x24) fx_savetype
    PATCH_IF (%fx_type% = 39 || %fx_type% = 142 || %fx_type% = 174) BEGIN //Sleep || Display Portrait Icon || Play sound
      WRITE_BYTE (%fx_off% + %i% * 0x30 + 0x3) 4 //Power
    END
  END

//ProjectileType difference
COPY_EXISTING ~WAND09.ITM~ ~override/WAND09.ITM~
  SAY IDENTIFIED_DESC @2333 //17658

  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x2A) abil_projectile_type
    PATCH_IF (%abil_type% = 3) BEGIN //Magical
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0xE) 1 //Ability range
      WRITE_BYTE (%abil_off% + %i% * 0x38 + 0x27) 0 //Ability item recharges? = DISABLED
    END
  END

COPY_EXISTING ~WAND10.ITM~ ~override/WAND10.ITM~
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num

  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    READ_SHORT (%abil_off% + %i% * 0x38 + 0x2A) abil_projectile_type
    PATCH_IF (%abil_type% = 3) BEGIN //Magical
      WRITE_SHORT (%abil_off% + %i% * 0x38 + 0x22) 100 //Ability #Charges
    END
  END

//BG2 has a different WAND12 and uses it; need to prefix with BG
//COPY_EXISTING ~WAND12.ITM~ ~override/WAND12.ITM~

COPY_EXISTING ~XBOW02.ITM~ ~override/XBOW02.ITM~
  WRITE_BYTE 0x26 11 //Minimum strength
  READ_STRREF UNIDENTIFIED_DESC temp_strref
  INNER_PATCH_SAVE new_strref "%temp_strref%" BEGIN
    REPLACE_TEXTUALLY ~ 12 ~ ~ 11 ~ //Change description to require 11 strength
  END
  SAY_EVALUATED UNIDENTIFIED_DESC "%new_strref%"
  READ_STRREF IDENTIFIED_DESC temp_strref
  INNER_PATCH_SAVE new_strref "%temp_strref%" BEGIN
    REPLACE_TEXTUALLY ~ 12 ~ ~ 11 ~ //Change description to require 11 strength
  END
  SAY_EVALUATED IDENTIFIED_DESC "%new_strref%"

COPY_EXISTING ~XBOW03.ITM~ ~override/XBOW03.ITM~
  WRITE_BYTE 0x26 11 //Minimum strength
  READ_STRREF UNIDENTIFIED_DESC temp_strref
  INNER_PATCH_SAVE new_strref "%temp_strref%" BEGIN
    REPLACE_TEXTUALLY ~ 12 ~ ~ 11 ~ //Change description to require 11 strength
  END
  SAY_EVALUATED UNIDENTIFIED_DESC "%new_strref%"
  READ_STRREF IDENTIFIED_DESC temp_strref
  INNER_PATCH_SAVE new_strref "%temp_strref%" BEGIN
    REPLACE_TEXTUALLY ~ 12 ~ ~ 11 ~ //Change description to require 11 strength
  END
  SAY_EVALUATED IDENTIFIED_DESC "%new_strref%"
/////////////////////////////////////////////////////////////



//#23 Disable hostile reaction after charm///////////////////
BEGIN @2300
DESIGNATED 2300

COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
                          ~^.+\.spl$~ ~override~
  PATCH_IF ("%SOURCE_RES%" STRING_COMPARE_CASE "SPWI939") != 0 AND
           ("%SOURCE_SIZE%" > 0x71) BEGIN
    READ_LONG  0x64 abil_off
    READ_SHORT 0x68 abil_num
    READ_LONG  0x6a fx_off
    PATCH_IF ("%SOURCE_FILE%" STRING_COMPARE_REGEXP "^.+\.spl$" = 0) BEGIN
      SET "abil_length" = 0x28
    END ELSE BEGIN
      SET "abil_length" = 0x38
    END
    FOR (index = 0 ; index < abil_num ; index = index + 1) BEGIN // start iterating through abilities
      READ_SHORT  ("%abil_off%" + 0x1e + ("%abil_length%" * "%index%")) "abil_fx_num"
      READ_SHORT  ("%abil_off%" + 0x20 + ("%abil_length%" * "%index%")) "abil_fx_idx"
      FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
        READ_SHORT ("%fx_off%" +        (0x30 * ("%abil_fx_idx%" + "%index2%"))) "opcode"
        PATCH_IF ("%opcode%" = 5) BEGIN // if there's a charm opcode
          READ_BYTE ("%fx_off%" + 0x8 + (0x30 * ("%abil_fx_idx%" + "%index2%"))) "charm_type"
          PATCH_IF ("%charm_type%" = 3) BEGIN
            WRITE_BYTE ("%fx_off%" + 0x8 + (0x30 * ("%abil_fx_idx%" + "%index2%"))) 2
          END ELSE
          PATCH_IF ("%charm_type%" = 1) BEGIN
            WRITE_BYTE ("%fx_off%" + 0x8 + (0x30 * ("%abil_fx_idx%" + "%index2%"))) 0
          END          
        END
      END
    END
  END
BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING_REGEXP GLOB ~^.+\.eff$~ ~override~
  PATCH_IF ("%SOURCE_SIZE%" > 0x109) BEGIN
    READ_SHORT 0x10 "opcode"
    PATCH_IF "%opcode%" = 5 BEGIN // if there's a charm opcode
      READ_BYTE 0x20 "charm_type"
      PATCH_IF ("%charm_type%" = 3) BEGIN
        WRITE_BYTE 0x20 2
      END ELSE
      PATCH_IF ("%charm_type%" = 1) BEGIN
        WRITE_BYTE 0x20 0
      END          
    END
  END
BUT_ONLY_IF_IT_CHANGES
/////////////////////////////////////////////////////////////



//#24 Enemy items shatter////////////////////////////////////
BEGIN @2400
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 2400
FORBID_COMPONENT ~Setup-BGTTweak.tp2~ 1501 @7

COPY ~BGTTweak/24/CREExcl.txt~ ~BGTTweak/24/CREExcl.txt~
  READ_2DA_ENTRIES_NOW ~_#_#_#read_CREExcl~ 1
  FOR (i = 1; i < _#_#_#read_CREExcl; i+=1) BEGIN
    READ_2DA_ENTRY_FORMER ~_#_#_#read_CREExcl~ i 0 CRE
    TO_UPPER %CRE%
    SET $excludeCRElist(EVALUATE_BUFFER "%CRE%") = 1
  END
BUT_ONLY_IF_IT_CHANGES

PRINT ~Clearing duplicate scripts...~
COPY_EXISTING_REGEXP GLOB ~^.+\.CRE$~ ~override~
  PATCH_IF NOT VARIABLE_IS_SET $excludeCRElist(EVALUATE_BUFFER "%SOURCE_RES%") BEGIN
    LAUNCH_PATCH_MACRO ~__24__readCRE~

    //clear duplicate scripts
    PHP_EACH scriptlist AS idx => script BEGIN
      PATCH_IF FILE_EXISTS_IN_GAME ~%script%.bcs~ BEGIN
        FOR (i = 0; i < idx; i += 1) BEGIN
          PATCH_IF ($scriptlist(EVALUATE_BUFFER "%i%") STRING_EQUAL_CASE "%script%") BEGIN
            PATCH_PRINT ~%SOURCE_FILE%: removing duplicated script (%script%)...~
            WRITE_ASCII (0x268 - %i% * 0x8) "" #8
            SPRINT $scriptlist(EVALUATE_BUFFER "%i%") ""
          END
        END
      END
    END
          
    //tally script usage
    SET numscripts = 0
    PHP_EACH scriptlist AS idx => script BEGIN
      PATCH_IF FILE_EXISTS_IN_GAME ~%script%.bcs~ BEGIN
        PATCH_IF NOT VARIABLE_IS_SET $scriptusage(EVALUATE_BUFFER "%script%") BEGIN
          SET $scriptusage(EVALUATE_BUFFER "%script%") = 1
        END ELSE BEGIN
          SET $scriptusage(EVALUATE_BUFFER "%script%") += 1
        END
        SET numscripts += 1
      END
    END

    //group into 5 scripts and <5 scripts
    PATCH_IF (numscripts = 5) BEGIN
      SET $script5list(EVALUATE_BUFFER "%SOURCE_RES%") = %numscripts%
    END ELSE BEGIN
      SET $scriptLT5list(EVALUATE_BUFFER "%SOURCE_RES%") = %numscripts%
    END
  END
BUT_ONLY_IF_IT_CHANGES

OUTER_SET iterate = 1
OUTER_SET iterate_num = 0
OUTER_SET priorityIdx = 0

//main loop
OUTER_WHILE (iterate) BEGIN

OUTER_SET iterate_num = iterate_num + 1
OUTER_SET problem = 0

PRINT ~Doing iteration #%iterate_num%...~

SILENT

ACTION_PHP_EACH prioritylist AS idx => file BEGIN
  ACTION_IF FILE_EXISTS_IN_GAME ~%file%.CRE~ BEGIN
    ACTION_IF VARIABLE_IS_SET $script5list(EVALUATE_BUFFER "%file%") BEGIN
      OUTER_SET numscripts = 5 //$script5list(EVALUATE_BUFFER "%file%")
    END ELSE BEGIN
      OUTER_SET numscripts = $scriptLT5list(EVALUATE_BUFFER "%file%")
    END

    COPY_EXISTING ~%file%.CRE~ ~override~
      LAUNCH_PATCH_MACRO ~__24__parseCRE~
    BUT_ONLY_IF_IT_CHANGES
  END
END

ACTION_PHP_EACH script5list AS file => numscripts BEGIN
  ACTION_IF VARIABLE_IS_SET $script5list(EVALUATE_BUFFER "%file%") BEGIN
    OUTER_SET isPriority = 0
    ACTION_PHP_EACH prioritylist AS idx => pfile BEGIN
      ACTION_IF ("%pfile%" STRING_EQUAL_CASE "%file%") BEGIN
        OUTER_SET isPriority = 1
      END
    END
    ACTION_IF (!isPriority) BEGIN
      COPY_EXISTING ~%file%.CRE~ ~override~
        LAUNCH_PATCH_MACRO ~__24__parseCRE~
      BUT_ONLY_IF_IT_CHANGES
    END
  END
END

ACTION_IF (!problem) BEGIN
  ACTION_PHP_EACH scriptLT5list AS file => numscripts BEGIN
    ACTION_IF VARIABLE_IS_SET $scriptLT5list(EVALUATE_BUFFER "%file%") BEGIN
      OUTER_SET isPriority = 0
      ACTION_PHP_EACH prioritylist AS idx => pfile BEGIN
        ACTION_IF ("%pfile%" STRING_EQUAL_CASE "%file%") BEGIN
          OUTER_SET isPriority = 1
        END
      END
      ACTION_IF (!isPriority) BEGIN
        COPY_EXISTING ~%file%.CRE~ ~override~
          LAUNCH_PATCH_MACRO ~__24__parseCRE~
        BUT_ONLY_IF_IT_CHANGES
      END
    END
  END

  VERBOSE

  //consistency check
  COPY_EXISTING_REGEXP GLOB ~^.+\.CRE$~ ~override~
    PATCH_IF NOT VARIABLE_IS_SET $excludeCRElist(EVALUATE_BUFFER "%SOURCE_RES%") BEGIN

      LAUNCH_PATCH_MACRO ~__24__readCRE~

      //count number of extensions
      SET extends = 0
      PATCH_PHP_EACH scriptlist AS idx => script BEGIN
        PATCH_IF FILE_EXISTS_IN_GAME ~%script%.bcs~ BEGIN
          PATCH_IF VARIABLE_IS_SET $extendlist(EVALUATE_BUFFER "%script%") AND
                   ($extendlist(EVALUATE_BUFFER "%script%") = 1) BEGIN
            SET extends += 1
          END
        END
      END

      PATCH_IF (extends > 1) BEGIN
        SET problem = 1

        PATCH_PRINT ~%SOURCE_FILE%: multiple extends.~
        PATCH_SILENT

        SET isPriority = 0
        PHP_EACH prioritylist AS idx => file BEGIN
          PATCH_IF ("%SOURCE_RES%" STRING_EQUAL_CASE "%file%") BEGIN
            SET isPriority = 1
          END
        END
        PATCH_IF (!isPriority) BEGIN
          SPRINT $prioritylist(EVALUATE_BUFFER "%priorityIdx%") "%SOURCE_RES%"
          SET priorityIdx += 1
        END ELSE BEGIN
          INNER_ACTION BEGIN
            FAIL ~Conflict in priority list.~
          END
        END
      END

    END
  BUT_ONLY_IF_IT_CHANGES
END

ACTION_IF (problem) BEGIN
  //prompt to continue if 10th iteration fails
  ACTION_IF (%iterate_num% >= 10) BEGIN
    OUTER_SPRINT yesno ""
    OUTER_WHILE ("%yesno%" STRING_COMPARE_CASE "y" != 0) AND
                ("%yesno%" STRING_COMPARE_CASE "n" != 0) BEGIN
      PRINT ~Iteration #%iterate_num% failed. Continue? [Y/N]~
      ACTION_READLN ~yesno~
      ACTION_IF ("%yesno%" STRING_COMPARE_CASE "n" == 0) BEGIN
        FAIL ~User aborted after %iterate_num% failed iterations.~
      END
    END
  END

  ACTION_PHP_EACH extendlist AS script => val BEGIN
    OUTER_SET $extendlist(EVALUATE_BUFFER ~%script%~) = 0
  END
  ACTION_PHP_EACH excludelist AS script => val BEGIN
    OUTER_SET $excludelist(EVALUATE_BUFFER ~%script%~) = 0
  END
  ACTION_PHP_EACH createlist AS file => val BEGIN
    OUTER_SET $createlist(EVALUATE_BUFFER ~%file%~) = 0
  END
  OUTER_PATCH ~~ BEGIN
    CLEAR_ARRAY extendlist
    CLEAR_ARRAY excludelist
    CLEAR_ARRAY createlist
  END
END ELSE BEGIN
  OUTER_SET iterate = 0
  PRINT ~Iteration #%iterate_num% successful.~
END

END //main loop


//Finally do the stuff
PRINT ~Extending scripts...~
SILENT
ACTION_PHP_EACH extendlist AS script => val BEGIN
  //extend these scripts
  ACTION_IF VARIABLE_IS_SET $extendlist(EVALUATE_BUFFER "%script%") AND
            ($extendlist(EVALUATE_BUFFER "%script%") = 1) BEGIN
    ACTION_IF MOD_IS_INSTALLED ~SETUP-BGTTWEAK.TP2~ 1502 BEGIN
      EXTEND_TOP ~%script%.bcs~ ~BGTTweak/24/A6SHATT2.BAF~
    END
    EXTEND_TOP ~%script%.bcs~ ~BGTTweak/24/A6SHATTE.BAF~
  END
END

PRINT ~Modifying creatures...~
SILENT
ACTION_PHP_EACH createlist AS file => val BEGIN
  //set to some common compiled script for each
  ACTION_IF VARIABLE_IS_SET $createlist(EVALUATE_BUFFER "%file%") AND
            ($createlist(EVALUATE_BUFFER "%file%") = 1) BEGIN
    COPY_EXISTING ~%file%.cre~ ~override~
      LAUNCH_PATCH_MACRO ~__24__readCRE~

      PATCH_IF NOT FILE_EXISTS_IN_GAME "%scriptlist_0%.bcs" BEGIN
        WRITE_ASCII 0x268 "A6SHATTE" #8
      END ELSE
      PATCH_IF NOT FILE_EXISTS_IN_GAME "%scriptlist_1%.bcs" BEGIN
        WRITE_ASCII 0x260 "A6SHATTE" #8
      END ELSE
      PATCH_IF NOT FILE_EXISTS_IN_GAME "%scriptlist_2%.bcs" BEGIN
        WRITE_ASCII 0x258 "A6SHATTE" #8
      END ELSE
      PATCH_IF NOT FILE_EXISTS_IN_GAME "%scriptlist_3%.bcs" BEGIN
        WRITE_ASCII 0x250 "A6SHATTE" #8
      END ELSE
      PATCH_IF NOT FILE_EXISTS_IN_GAME "%scriptlist_4%.bcs" BEGIN
        WRITE_ASCII 0x248 "A6SHATTE" #8
      END ELSE
      INNER_PATCH ~~ BEGIN
        PATCH_PRINT ~%SOURCE_FILE% not patched - all script slots full~
        PATCH_SILENT
      END
    BUT_ONLY_IF_IT_CHANGES
  END
END
VERBOSE

COMPILE ~BGTTweak/24/A6SHATTE.BAF~
ACTION_IF MOD_IS_INSTALLED ~SETUP-BGTTWEAK.TP2~ 1502 BEGIN
  EXTEND_BOTTOM ~A6SHATTE.BCS~ ~BGTTweak/24/A6SHATT2.BAF~
END
/////////////////////////////////////////////////////////////



//#25 Access Ulgoth's Beard west of Wyrm's Crossing only////
BEGIN @2500
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~BGPOTN14.ITM~) @10
DESIGNATED 2500
//FORBID_COMPONENT ~Setup-BP-BGT-Worldmap.tp2~ ~0~ @11

COPY ~BGTTweak/25/AR7900SR.BMP~ ~override/AR7900SR.BMP~

COPY_EXISTING ~WORLDMAP.WMP~ ~override/WORLDMAP.WMP~
  READ_LONG 0x30 area_entry_num
  READ_LONG 0x34 area_entry_off
  READ_LONG 0x38 area_link_off
  READ_LONG 0x3c area_link_num

  FOR (i = 0; i < %area_entry_num%; i+=1) BEGIN
    READ_ASCII (%area_entry_off% + %i% * 0xf0) area_short_name
    PATCH_IF ("%area_short_name%" STRING_COMPARE_CASE "AR7900" = 0) BEGIN

      //removing the North link
      READ_LONG (%area_entry_off% + %i% * 0xf0 + 0x50) area_first_link_N
      READ_LONG (%area_entry_off% + %i% * 0xf0 + 0x54) area_links_N

      FOR (j = 0; j < %area_links_N%; j+=1) BEGIN
        READ_LONG (%area_link_off% + %area_first_link_N% * 0xd8 + %j% * 0xd8) link_target_area

        READ_ASCII (%area_entry_off% + %link_target_area% * 0xf0) link_target_area_short_name
        PATCH_IF ("%link_target_area_short_name%" STRING_COMPARE_CASE "ARU000" = 0) BEGIN
          DELETE_BYTES (%area_link_off% + %area_first_link_N% * 0xd8 + %j% * 0xd8) 0xd8

          SET area_link_num = area_link_num - 1
          WRITE_LONG 0x3c %area_link_num%

          SET area_links_N = area_links_N - 1
          WRITE_LONG (%area_entry_off% + %i% * 0xf0 + 0x54) area_links_N

          READ_LONG (%area_entry_off% + %i% * 0xf0 + 0x58) area_first_link_W
          PATCH_IF (%area_first_link_W% > %area_first_link_N%) BEGIN
            SET area_first_link_W = area_first_link_W - 1
            WRITE_LONG (%area_entry_off% + %i% * 0xf0 + 0x58) area_first_link_W
          END

          READ_LONG (%area_entry_off% + %i% * 0xf0 + 0x60) area_first_link_S
          PATCH_IF (%area_first_link_S% > %area_first_link_N%) BEGIN
            SET area_first_link_S = area_first_link_S - 1
            WRITE_LONG (%area_entry_off% + %i% * 0xf0 + 0x60) area_first_link_S
          END

          READ_LONG (%area_entry_off% + %i% * 0xf0 + 0x68) area_first_link_E
          PATCH_IF (%area_first_link_E% > %area_first_link_N%) BEGIN
            SET area_first_link_E = area_first_link_E - 1
            WRITE_LONG (%area_entry_off% + %i% * 0xf0 + 0x68) area_first_link_E
          END

          FOR (k = i+1; k < %area_entry_num%; k+=1) BEGIN
            READ_LONG (%area_entry_off% + %k% * 0xf0 + 0x50) area_first_link_N
            SET area_first_link_N = area_first_link_N - 1
            WRITE_LONG (%area_entry_off% + %k% * 0xf0 + 0x50) area_first_link_N

            READ_LONG (%area_entry_off% + %k% * 0xf0 + 0x58) area_first_link_W
            SET area_first_link_W = area_first_link_W - 1
            WRITE_LONG (%area_entry_off% + %k% * 0xf0 + 0x58) area_first_link_W

            READ_LONG (%area_entry_off% + %k% * 0xf0 + 0x60) area_first_link_S
            SET area_first_link_S = area_first_link_S - 1
            WRITE_LONG (%area_entry_off% + %k% * 0xf0 + 0x60) area_first_link_S

            READ_LONG (%area_entry_off% + %k% * 0xf0 + 0x68) area_first_link_E
            SET area_first_link_E = area_first_link_E - 1
            WRITE_LONG (%area_entry_off% + %k% * 0xf0 + 0x68) area_first_link_E
          END
        END
      END

      //adding the West link
      READ_LONG (%area_entry_off% + %i% * 0xf0 + 0x58) area_first_link_W
      READ_LONG (%area_entry_off% + %i% * 0xf0 + 0x5c) area_links_W

      //add to bottom (like DLTCEP behaviour)
      INSERT_BYTES (%area_link_off% + %area_first_link_W% * 0xd8 + %area_links_W% * 0xd8) 0xd8

      //find target area index
      FOR (j = 0; j < %area_entry_num%; j+=1) BEGIN
        READ_ASCII (%area_entry_off% + %j% * 0xf0) area_short_name
        PATCH_IF ("%area_short_name%" STRING_COMPARE_CASE "ARU000" = 0) BEGIN
          SET link_target_area = j
        END
      END

      //fill in details
      WRITE_LONG (%area_link_off% + %area_first_link_W% * 0xd8 + %area_links_W% * 0xd8) %link_target_area% //target area index
      WRITE_ASCII (%area_link_off% + %area_first_link_W% * 0xd8 + %area_links_W% * 0xd8 + 0x4) "EXIT8300" #32 //entrance
      WRITE_LONG (%area_link_off% + %area_first_link_W% * 0xd8 + %area_links_W% * 0xd8 + 0x24) 4 //travel time
      WRITE_LONG (%area_link_off% + %area_first_link_W% * 0xd8 + %area_links_W% * 0xd8 + 0x28) 1 //flags
      WRITE_LONG (%area_link_off% + %area_first_link_W% * 0xd8 + %area_links_W% * 0xd8 + 0x54) 5 //random encounter probability

      SET area_link_num = area_link_num + 1
      WRITE_LONG 0x3c %area_link_num%

      SET area_links_W = area_links_W + 1
      WRITE_LONG (%area_entry_off% + %i% * 0xf0 + 0x5c) area_links_W

      READ_LONG (%area_entry_off% + %i% * 0xf0 + 0x50) area_first_link_N
      PATCH_IF (%area_first_link_N% > %area_first_link_W%) BEGIN
        SET area_first_link_N = area_first_link_N + 1
        WRITE_LONG (%area_entry_off% + %i% * 0xf0 + 0x50) area_first_link_N
      END

      READ_LONG (%area_entry_off% + %i% * 0xf0 + 0x60) area_first_link_S
      PATCH_IF (%area_first_link_S% > %area_first_link_W%) BEGIN
        SET area_first_link_S = area_first_link_S + 1
        WRITE_LONG (%area_entry_off% + %i% * 0xf0 + 0x60) area_first_link_S
      END

      READ_LONG (%area_entry_off% + %i% * 0xf0 + 0x68) area_first_link_E
      PATCH_IF (%area_first_link_E% > %area_first_link_W%) BEGIN
        SET area_first_link_E = area_first_link_E + 1
        WRITE_LONG (%area_entry_off% + %i% * 0xf0 + 0x68) area_first_link_E
      END

      FOR (k = i+1; k < %area_entry_num%; k +=1) BEGIN
        READ_LONG (%area_entry_off% + %k% * 0xf0 + 0x50) area_first_link_N
        SET area_first_link_N = area_first_link_N + 1
        WRITE_LONG (%area_entry_off% + %k% * 0xf0 + 0x50) area_first_link_N

        READ_LONG (%area_entry_off% + %k% * 0xf0 + 0x58) area_first_link_W
        SET area_first_link_W = area_first_link_W + 1
        WRITE_LONG (%area_entry_off% + %k% * 0xf0 + 0x58) area_first_link_W

        READ_LONG (%area_entry_off% + %k% * 0xf0 + 0x60) area_first_link_S
        SET area_first_link_S = area_first_link_S + 1
        WRITE_LONG (%area_entry_off% + %k% * 0xf0 + 0x60) area_first_link_S

        READ_LONG (%area_entry_off% + %k% * 0xf0 + 0x68) area_first_link_E
        SET area_first_link_E = area_first_link_E + 1
        WRITE_LONG (%area_entry_off% + %k% * 0xf0 + 0x68) area_first_link_E
      END

    END
  END
BUT_ONLY_IF_IT_CHANGES
/////////////////////////////////////////////////////////////


//#26 Prevent access to Durlag's Tower from adjacent areas///
BEGIN @2600
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~BGPOTN14.ITM~) @10
DESIGNATED 2600
//FORBID_COMPONENT ~Setup-BP-BGT-Worldmap.tp2~ ~0~ @11

COPY_EXISTING ~WORLDMAP.WMP~ ~override/WORLDMAP.WMP~
  READ_LONG 0x30 area_entry_num
  READ_LONG 0x34 area_entry_off
  READ_LONG 0x38 area_link_off
  READ_LONG 0x3c area_link_num

  FOR (i = 0; i < %area_entry_num%; i+=1) BEGIN
    READ_ASCII (%area_entry_off% + %i% * 0xf0) area_short_name
    PATCH_IF ("%area_short_name%" STRING_COMPARE_CASE "ARD000" = 0) BEGIN
      READ_LONG (%area_entry_off% + %i% * 0xf0 + 0x30) area_flags
      SET area_flags = area_flags BAND 0b00000100
      WRITE_LONG (%area_entry_off% + %i% * 0xf0 + 0x30) area_flags
    END
  END
BUT_ONLY_IF_IT_CHANGES
/////////////////////////////////////////////////////////////

//#27 Put Sword of Chaos +2 in Sarevok's inventory///////////
BEGIN @2700
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~AMNSCENE.BCS~) @1
DESIGNATED 2700

//check if Sarevok already has the sword
COPY_EXISTING ~SAREVO.CRE~ ~override/SAREVO.CRE~
  READ_LONG 0x2b8 itemslot_off
  READ_LONG 0x2bc item_off
  READ_LONG 0x2c0 item_num

  SET item_found = 0
  FOR (i = 0; i < %item_num%; i +=1) BEGIN
    READ_ASCII (%item_off% + %i% * 0x14) item_name
    PATCH_IF !("%item_name%" STRING_COMPARE_CASE "SW2H16") BEGIN
      FOR (j = 0; j < 37; j += 1) BEGIN
        READ_SHORT (%itemslot_off% + %j% * 0x2) itemslot_idx
        PATCH_IF %itemslot_idx% = %i% BEGIN
          SET item_found = 1
        END
      END
    END
  END

  PATCH_IF item_found = 0 BEGIN
    ADD_CRE_ITEM ~SW2H16~ #0 #0 #0 ~NONE~ ~INV16~
  END
/////////////////////////////////////////////////////////////